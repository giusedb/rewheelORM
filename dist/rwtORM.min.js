"use strict";function Handler(){this.handlers=[],this.strHandlers={}}function NamedEventManager(){var t={},e={},n=0;this.on=function(o,i){o in t||(t[o]=new Array);var r=n++;return t[o].push(i),e[r]=i,r},this.emit=function(e){if(e in t){var n=Array.prototype.slice.call(arguments,1);t[e].forEach(function(t){t.apply(null,n)})}},this.unbind=function(n){var o=0;if(n in e){var i=e[n+""];Lazy(t).each(function(t,e){var n=[];for(var r in t)t[r]===i&&(n.push(r),o++);n.reverse().forEach(function(e){t.splice(e,1)})})}return delete e[n],o}}function xdr(t,e,n,o,i,r){var s;e&&e.constructor===Object&&(e=JSON.stringify(e)),XMLHttpRequest?(s=new XMLHttpRequest,"withCredentials"in s&&(s.open("POST",t,!0),s.onerror=o,s.onreadystatechange=function(){if(4===s.readyState)if(s.status>=200&&s.status<400){try{var t=JSON.parse(s.responseText)}catch(t){var t=s.responseText}n(t,s.statusText,s)}else o(new Error("Response returned with non-OK status"))},i&&s.setRequestHeader("application",i),r&&s.setRequestHeader("token",r),s.setRequestHeader("Accept","application/json"),s.send(e))):XDomainRequest?(s=new XDomainRequest,s.open("POST",t),s.onerror=o,s.onload=function(){n(s.responseText,s.statusText,s)},i&&s.setRequestHeader("application",i),r&&s.setRequestHeader("token",r),s.send(e)):o(new Error("CORS not supported"))}function reWheelConnection(t,e){this.getLogin=e,this.events=new NamedEventManager,this.$POST=$POST.bind(this),this.options={endPoint:t},this.on=this.events.on.bind(this)}function cachedPropertyByEvents(t,e,n,o){var i=Array.prototype.slice.call(arguments,4),r={};Lazy(i).each(function(e){t.orm.on(e,function(){r={}})});var s={get:function(){return this.id in r||(r[this.id]=n.call(this)),r[this.id]}};o&&(s.set=function(t){t!==r[this.id]&&(o.call(this,t),this.id in r&&delete r[this.id])}),Object.defineProperty(t,e,s)}function ValidationError(t){this.resource=t._resource,this.formIdx=t.formIdx,this.fields=t.errors}function reWheelORM(t){this.$orm=new baseORM(t,this),this.on=this.$orm.on.bind(this.$orm)}Handler.prototype.addHandler=function(t){var e=utils.hash(t.toString());e in this.strHandlers||(this.strHandlers[e]=t,this.handlers.push(t))},Handler.prototype.handle=function(){var t=Array.prototype.slice.call(arguments,0);this.handlers.forEach(function(e){e.apply(null,t)})},Handler.prototype.handleBy=function(){var t=Array.prototype.slice.call(arguments,1),e=arguments[0];this.handlers.forEach(function(n){n.apply(e,t)})};var cachedKeyIdx=0,cached=function(t,e){function n(){return this[e]||(this[e]=t.call(this,[arguments])),this[e]}return e||(e="_"+cachedKeyIdx++),n},$POST=function(t,e,n,o,i){var r={accepts:"application/json",url:t,data:JSON.stringify(e),dataType:"json",success:n,error:o,method:"POST",contentType:"application/json"};return i&&(r.headers=i,r.crossDomain=!0),$.ajax(r)};reWheelConnection.prototype.status=function(t,e){if("lastRWTStatus"in localStorage&&!e){try{var n=JSON.parse(localStorage.lastRWTStatus);for(var o in n)this.options[o]=n[o]}catch(e){return this.status(t,!0)}return t&&t(n)}if(this._status_calling){var i=this;return setTimeout(function(){i.status(t)},50)}if(!this.options||!this.options.timestamp){this._status_calling=!0;var i=this;return this.$post("api/status",null,function(e){localStorage.lastRWTStatus=JSON.stringify(e),i._status_calling=!1;for(var n in e)i.options[n]=e[n];if(!e.user_id&&i.getLogin){var o=i.getLogin();o.constructor===Object&&i.login(o.username,o.password).then(function(e){for(var n in e)i.options[n]=e[n];localStorage.lastRWTStatus=JSON.stringify(e),t&&t(e)})}else t&&t(i.options)})}t&&t(this.options)},reWheelConnection.prototype.$post=function(t,e,n){var o=this;if(this.options&&this.options.token&&(e||(e={})),this.options.token){({token:this.options.token,application:this.options.application})}else;var i=xdr(this.options.endPoint+t,e,function(i,r,s){o.events.emit("http-response",i,s.status,t,e),o.events.emit("http-response-"+s.status,i,t,e),n&&n(i)},function(n){try{var i=JSON.parse(n.responseText);o.events.emit("error-json",i,n.status,t,e,n),o.events.emit("error-json-"+n.status,i,t,e,n)}catch(i){o.events.emit("error-http",n.responseText,n.status,t,e,n),o.events.emit("error-http-"+n.status,n.responseText,t,e,n)}},this.options.application,this.options.token);return i},reWheelConnection.prototype.login=function(t,e){var n=this.options.endPoint+"api/login",o=this,i=null;return this.options.token&&(i={token:this.options.token}),new Promise(function(i,r){$.ajax({url:n,data:{username:t,password:e},dataType:"json",method:"POST",mimeType:"application/json",crossDomain:!0,success:function(t){for(var e in t)o.options[e]=t[e];i(t)},error:function(t,e,n){r(t.responseJSON)}})})},reWheelConnection.prototype.connect=function(t){var e=this,n=function(t){t.wsConnection=new utils.wsConnect(t.options),t.wsConnection.onConnect(function(){t.events.emit("ws-connected",t.wsConnection)}),t.wsConnection.onDisconnect(function(){setTimeout(function(){n(t)},1e3)})};return this.status(function(o){"token"in e.options?t&&t(o):(console.log("connecting to "+e.options.endPoint),e.options.username&&e.options.password&&e.login(e.options.username,e.options.password,function(e){t&&t(e),console.log("renewing connection")})),o.token&&o.realtimeEndPoint&&!e.wsConnection&&n(e)})};var utils={renameFunction:function(t,e){return new Function("return function (call) { return function "+t+" () { return call(this, arguments) }; };")()(Function.apply.bind(e))},log:function(){console.log(arguments)},setToParent:function(t,e,n){if(e in t){for(var o=t,i=o;o&&e in o;)i=o,o=o.$parent;e in i&&(i[e]=n)}},capitalize:function(t){return t[0].toUpperCase()+t.slice(1).toLowerCase()},hash:function(t){t=t.toString();for(var e=1,n=0;n<t.length;n++)e*=1+t.charCodeAt(n);return(e%34958374957).toString()},makeListCacheKey:function(t,e){return JSON.stringify(Lazy(t).map(function(t,e){return[e,Lazy(t).map(function(t){return t+""}).sort().toArray()]}).toObject())},makeFilter:function(t,e){var n=Lazy(e).map(function(e,n){if(e.constructor==Array)e=Lazy(e).map(function(t){return[t,1]}).toObject();else if(isFinite(e)||"Number"==typeof e){var o={};o[e]=1,e=o}return Lazy(t.references).contains(n)&&(n="_"+n),[n,e]}).toObject();return function(t){return Lazy(n).all(function(e,n){return t[n]in e})}},sameAs:function(t,e){for(var n in t)if(e[n]!=t[n])return!1;return!0},wsConnect:function(t){if(t){var e=this;this.handlers={wizard:new Handler,onConnection:new Handler,onDisconnection:new Handler,onMessageJson:new Handler,onMessageText:new Handler},this.onWizard=this.handlers.wizard.addHandler.bind(this.handlers.wizard),this.onConnect=this.handlers.onConnection.addHandler.bind(this.handlers.onConnection),this.onDisconnect=this.handlers.onDisconnection.addHandler.bind(this.handlers.onDisconnection),this.onMessageJson=this.handlers.onMessageJson.addHandler.bind(this.handlers.onMessageJson),this.onMessageText=this.handlers.onMessageText.addHandler.bind(this.handlers.onMessageText),this.options=t;var n=new SockJS(t.realtimeEndPoint);n.onopen=function(t){console.log("open : "+t),n.tenant(),e.handlers.onConnection.handle(t)},n.onmessage=function(t){if("message"==t.type)try{e.handlers.onMessageJson.handle($.parseJSON(t.data))}catch(n){e.handlers.onMessageText.handle(t.data)}else console.log(t)},n.onclose=function(){setTimeout(utils.wsConnect,1e3),e.handlers.onDisconnection.handle()},n.tenant=function(){n.send("TENANT:"+e.options.application+":"+e.options.token)}}},pluralize:function(t,e){return t+"s"},beforeCall:function(t,e){var n=function(){e().then(t)};return n},cleanStorage:function(){Lazy(localStorage).keys().each(function(t){delete localStorage[t]})},reverse:function(t,e){return e.split(t).reverse().join(t)},permutations:function(t){for(var e=[],n=t.length-1;n>=0;n--)for(var o=t.length-1;o>=0;o--)n!==o&&e.push([t[n],t[o]]);return e},bool:Boolean,noop:function(){}},tzOffset=6e4*(new Date).getTimezoneOffset(),findControllerScope=function(t){for(var e=t,n=void 0,o=!0,i=Lazy(Lazy(t).find(function(t,e){return t&&t.constructor.$inject}).constructor.$inject);e;){o=!1;var r=Lazy(e).find(function(t,e){return t&&t.constructor.$inject});if(r&&(o=0==i.difference(r.constructor.$inject).size()),!o)return n||t.$parent;n=e,e=e.$parent}return t.$parent},findControllerAs=function(t,e){for(var n=t;n;){var o=e(n);if(o)return n;n=n.$parent}};!function(t,e){"function"==typeof define&&define.amd?define(e):"object"==typeof exports?module.exports=e():t.ListCacher=e()}(this,function(t){function e(){var t={},n={},o={};this.filter=function(i,r){console.info(r);var s=this.getIndexFor,a=i.modelName;if(a in t)return null;if(0==Lazy(r).size())return t[a]=!0,a in n&&delete n[a],{};var c=Lazy(r).map(function(t,e){return[e,a+"."+e]}).toObject(),u=Lazy(r).keys().map(function(t){return[t,s(a,t)]}).toObject(),l=Lazy(r).map(function(t,e){return[e,Lazy(t).difference(n[c[e]]).unique().toArray()]}).filter(function(t){return t[1].length}).toObject(),d=Lazy(l).size(),f=Lazy(r).size();return d<f?null:(1==d?Lazy(r).each(function(t,e){var o=Lazy(t).difference(u[e]).toArray();o.length&&Array.prototype.push.apply(n[a+"."+e],t)}):Lazy(l).keys().each(function(t){t=c[t],t in o||(o[t]=new e);var n=Lazy(l).keys().map(function(e){return o[t].filter(i,Lazy(l).filter(function(t,n){return n!==e}).toObject())}).toArray();return Lazy({}).merge.apply(n.concat([function(t,e){return Lazy(t).union(e).toArray()}]))}),l)},this.getIndexFor=function(t,e){var o=t+"."+e;return o in n||(n[o]=[]),n[o]}}return e});var baseORM=function(t,e){function n(t,e,n){this.klass=e,this.permissions=[],this.id=t;for(var o in n)this.push.apply(this,[o,n[o]])}if(t.constructor===String)var o=new reWheelConnection(t);else if(t.constructor===reWheelConnection)var o=t;this.connection=o,o.on("connected",function(){this.connected=!0});var i=o.events;this.on=i.on.bind(this),this.emit=i.emit.bind(this),this.$post=o.$post.bind(o),i.on("ws-connected",function(t){console.info("Websocket connected"),t.onMessageJson(r.gotData.bind(r)),t.onMessageText(function(t){console.info("WS message : "+t)})}),i.on("ws-disconnected",function(t){console.error("Websocket disconnected")}),i.on("error-json-404",function(t,e,n,o){console.error("JSON error ",JSON.stringify(t)),delete h[e.split("/")[0]]});var r=this,s={auth_group:Lazy({})};window.DB=s;var a={},c={},u=Lazy([]),l={},d={},f={},p={},h={},y=new ListCacher,m=new AutoLinker(i,h,s,this,y);window.ll=m,window.lc=y,this.validationEvent=i.on("error-json-513",function(t,e,n,o){currentContext.savingErrorHanlder&&currentContext.savingErrorHanlder(new ValidationError(t))});var v=function(t){return t in s?s[t]:(s[t]=Lazy({}),s[t])},g=function(t){return t in UNLINKED?UNLINKED[t]:(UNLINKED[t]={},UNLINKED[t])};n.prototype.save=function(t){var e={permissions:Lazy(this.permissions).map(function(t){return[t[0].id,t[1]]}).toObject()};e.id=this.id;this.klass.modelName;W2P_POST(this.klass.modelName,"set_permissions",e,function(e,n,o,i){t(e)})},n.prototype.push=function(t,e){var n=Lazy(e),o=Lazy(this.klass.allPermissions).map(function(t){return[t,n.contains(t)]}).toObject(),i=Lazy(this.permissions).map(function(t){return t[0].id});i.contains(t)?this.permissions[i.indexOf(t)][1]=o:this.permissions.push([s.auth_group.get(t),o])};var z=function(t){var o=Lazy(t.fields);t.privateArgs&&(o=o.merge(t.privateArgs)),r.emit("model-definition",t);var u="if (!row) { row = {}};\n";u+=t.references.map(function(t){return"this._"+t.id+" = row."+t.id+";"}).join(";\n"),u+=o.map(function(t,e){return"date"==t.type||"datetime"==t.type?"this."+e+" = row."+e+"?new Date(row."+e+" * 1000 - tzOffset):null;\n":"boolean"==t.type?"this."+e+" = (row."+e+' === "T") || (row.'+e+" === true);\n":"this."+e+" = row."+e+";\n"}).toString("\n"),u+="if (permissions) {this._permissions = permissions && Lazy(permissions).map(function (x) { return [x, true] }).toObject();}";var p=new Function("row","permissions",u);p.prototype.orm=e,p.ref_translations={},p.modelName=t.name,p.references=Lazy(t.references).pluck("id").toArray(),p.inverse_references=t.referencedBy.map(function(t){return t.by+"_"+t.id+"_set"}),p.referents=t.referencedBy.map(function(t){return[t.by,t.id]}),p.fieldsOrder=t.fieldOrder,p.allPermissions=t.permissions,Lazy(t.representation).size()&&(p.prototype.toString=new Function("return this."+Lazy(t.representation).toString(' + " " + this.'))),p.prototype.toUpperCase=function(){return this.toString().toUpperCase()},p.prototype.toLowerCase=function(){return this.toString().toLowerCase()},p.prototype.delete=function(){return e.delete(this.constructor.modelName,[this.id])},p.prototype.all_perms=function(t){var e=this.id;rewheel.$post(this.constructor.modelName,"all_perms",{id:this.id},function(o){var i=o,r={},a=Lazy(i).pluck("group_id").unique().map(function(t){return""+t}).difference(s.auth_group.keys()).toArray();Lazy(i).groupBy(function(t){return t.group_id}).each(function(t,e){r[e]=Lazy(t).pluck("name").toArray()});var c=function(o){t(new n(e,p,r))};a.length?rewheel.$get("auth_group",a,void 0,c):c()})},p.prototype.save=function(t){if(t)for(var e in t)this[e]=t[e];var n={},o=this.asRaw();this.field;Lazy(this.constructor.fields).each(function(t){var e=p.privateArgs||{};"M2M"==t.type||!t.writable||t.id in e||(n[t.id]=o[t.id])});var i=r.$post(this.constructor.modelName+(this.id?"/post":"/put"),n);t&&t.constructor===Function&&(i.context.savingErrorHanlder=t)},p.prototype.copy=function(){var t=new this.constructor(this.asRaw());return t.permissions=this.permissions,t};var h="return {\n"+Lazy(t.references).map(function(t){return t.id+" : this._"+t.id}).concat(o.map(function(t,e){return"date"==t.type||"datetime"==t.type?e+" : (this."+e+"?(Math.round(this."+e+".getTime() - this."+e+".getTimezoneOffset() * 60000) / 1000):null)":"boolean"==t.type?e+" : this."+e+'?"T":"F"':e+" : this."+e})).toString(",\n")+"};";p.prototype.asRaw=new Function(h),p.saveMulti=function(t,e,n){var o=[],i=Lazy(p.fields).filter(function(t){return!t.writable}).pluck("id").toArray();Lazy(t).map(function(t){return t.asRaw()}).each(function(t){Lazy(i).each(function(e){delete t[e]}),o.push(t)}),r.$post(p.modelName,"put",{multiple:o,formIdx:r.formIdx++},function(t){r.gotData(t);var n=s[p.modelName],o=Lazy(t[p.modelName].results).pluck("id").map(function(t){return n.get(t)}).toArray();e&&e(o)},n)},"extra_verbs"in t&&Lazy(t.extra_verbs).each(function(t){var e=t[0],n=t[1],o="data = {id : this.id";n.length&&(o+=", "+Lazy(n).map(function(t){return t+" : "+t}).join(",")),o+="};",n.push("cb"),p.prototype[e]=new Function(n,o+'W2S.W2P_POST(this.constructor.modelName,"'+e+'", data,function(data,status,headers,x){try{\n   if (!headers("nomodel")) {window.W2S.gotData(data,cb);}\n   else {if (cb) {cb(data)}}\n} catch(e){\nif (cb) {cb(data);}\n}\n});\n')}),"privateArgs"in t&&(p.privateArgs=Lazy(t.privateArgs).keys().map(function(t){return[t,!0]}).toObject(),p.prototype.savePA=function(t){var e=this,n={id:this.id},o=this.constructor.privateArgs,i=this.constructor.fields,s=(new this.constructor(t).asRaw(),Lazy(o).keys().map(function(t){return[t,i[t]]}).toObject());Lazy(t).each(function(t,e){e in o&&s[e].writable&&(n[e]=t)}),r.$post(this.constructor.modelName+"/savePA",n,function(){Lazy(n).each(function(t,n){e[n]=t})})}),f[p.modelName]=p;for(var y in t.fields)t.fields[y].id=y;if(p.fields=Lazy(t.fields).concat(Lazy(t.privateArgs)).concat(Lazy(t.references).tap(function(t){t.type=t.type||"reference"})).indexBy("id").toObject(),Lazy(t.references).each(function(t){var n=t.to,o="_"+t.id;cachedPropertyByEvents(p.prototype,t.id,function(){if(!(n in s)){var t=this;r.describe(n,function(e){m.mainIndex[n].ask(t[o],!0)})}var e=n in s&&this[o]&&s[n].get(this[o]);return!e&&n in m.mainIndex?m.mainIndex[n].ask(this[o],!0):e},function(e){if(e&&e.constructor.modelName!=n)throw new TypeError("You can assign only "+n+" to "+t.id);this[o]=e.id},"new-"+n,"deleted-"+n,"updated-"+n,"new-model-"+n),p.prototype["get"+utils.capitalize(t.id)]=function(){return e.get(n,this[o])}}),Lazy(t.referencedBy).each(function(t){var n=t.by+"."+t.id,o=t.by+"_"+utils.pluralize(t.id),i=t.by;p.prototype.hasOwnProperty(o)?$log.error("Tryed to redefine property "+o+"s for "+p.modelName):cachedPropertyByEvents(p.prototype,o,function(){var t=i in s?a[n].get(this.id+""):null;return m.foreignKeys[n].ask(this.id,!0),t},null,"new-"+i,"updated-"+i,"deleted-"+i),p.prototype["get"+utils.capitalize(utils.pluralize(t.by))]=function(){var n={};return n[t.id]=[this.id],e.query(t.by,n)}}),t.manyToMany&&(Lazy(t.manyToMany).each(function(t){var e=t.indexName,n=t.first?0:1,o=t.model,i=m.m2mIndex[e]["get"+utils.capitalize(o)];cachedPropertyByEvents(p.prototype,t.model+"s",function(){var t=this,a=[],c=null,u=null;return m.getM2M(e,[t.id],n,function(e){c=i(t.id),c.length&&(r.fetch(o,{id:c}),u=v(o).get.bind(s[o]))}),c&&u&&(a=Lazy(c).map(u).filter(utils.bool).toArray()),a},null,"received-m2m-"+e),p.prototype["get"+utils.capitalize(utils.pluralize(o))]=function(){var t=this;return new Promise(function(a,c){try{m.getM2M(e,[t.id],n,function(e){var n=i(t.id);n.length?r.fetch(o,{id:n},null,function(){var t=s[o].get.bind(s[o]);a(Lazy(n).map(t).filter(utils.bool).toArray())}):a([])})}catch(t){console.error(t),c(t)}})},p.fields[utils.capitalize(o)]={id:utils.capitalize(o),name:utils.capitalize(o),writable:!0,readable:!0,type:"M2M",validators:[]}}),p.prototype.unlinkReference=function(t){var e=!1,n=this.id,o=[];"Array"==t.constructor.name&&(e=!0,o=t,t=o[0]);var i=t.constructor.modelName;if(e)var s=Lazy(o).pluck("id").map(function(t){return[n,t]}).toArray();else var s=[[n,t.id]];r.$post(p.modelName+"/"+i+"s/delete",{collection:s})},p.prototype.linkReference=function(t){var e=!1,n=this.id,o=[];"Array"==t.constructor.name&&(e=!0,o=t,t=o[0]);var i=t.constructor.modelName,s=p.modelName+"/"+i;if(e){var a=[];if(s in c&&(a=Lazy(o).pluck("id").difference(Lazy(c[s][0].get(this.id))).toArray()),s=i+"/"+p.modelName,s in c&&(a=Lazy(o).pluck("id").difference(Lazy(c[s][0].get(this.id))).toArray()),a.length){var u=Lazy(a).map(function(t){return[n,t]}).toArray();W2P_POST(p.modelName,i+"s/put",{collection:u},function(t){})}}else{if(s in m.m2mIndex&&Lazy(m.m2mIndex[s]["get"+utils.capitalize(i)](t.id)).find(this))return;r.$post(p.modelName+"/"+i+"s/put",{collection:[[this.id,t.id]]})}}),p.modelName in l)for(;l[p.modelName].length;){var g=l[p.modelName].pop();Lazy(d[p.modelName]).map(function(t){return t.toString()}).contains(g.toString())||(g(p),d[p.modelName].push(g))}return i.emit("new-model",p),i.emit("new-model-"+p.modelName),p};this.gotData=function(t,e){if(console.info("gotData"),"string"!=typeof t){"_extra"in t&&delete t._extra;var n=t.TOONE,o=t.TOMANY,c=t.MANYTOMANY,u=t.PERMISSIONS,l=t.PA;if(delete t.TOONE,delete t.TOMANY,delete t.MANYTOMANY,delete t.PERMISSIONS,delete t.PA,l||(l={}),t=Lazy(t).filter(function(t,e){return!("deleted"in t)||e in r.modelCache}).toObject(),"m2m"in t){var d=t.m2m;delete t.m2m}Lazy(t).each(function(t,e){r.describe(e,function(n){var o=n;t.results&&t.results.length>0&&t.results[0].constructor==Array&&(t.results=Lazy(t.results).map(function(t){return Lazy(o.fieldsOrder).zip(t).toObject()}).toArray());var r=Lazy(t.results),c=t.deleted;if(e in l){var u=l[e];Lazy(r).each(function(t){t.id in u&&Lazy(u[t.id]).each(function(e,n){t[n]=e})})}var d=v(e),p=d.source;c&&c.forEach(function(t){delete p[t]});var h=r.indexBy("id"),y=h.keys(),m=y.difference(d.keys().map(function(t){return parseInt(t)})),g=y.difference(m);g=g.filter(function(t){return!utils.sameAs(h.get(t),d.get(t).asRaw())});var z=t.permissions?Lazy(t.permissions):Lazy({}),L=m.map(function(t){return new o(h.get(t),z.get(t))}),w=[];g.each(function(t){var e=d.get(t),i=e.copy(),r=new o(h.get(t));Lazy(n.fields).keys().each(function(t){e[t]=r[t]}),w.push([e,i])}),w.length&&i.emit("updated-"+e,w);var N=L.toArray();Lazy(N).each(function(t){p[t.id]=t}),Lazy(f[e].references).each(function(t){a[e+"."+t]=s[e].groupBy("_"+t)}),N.length&&i.emit("new-"+e,Lazy(N),t.totalResults),c&&i.emit("deleted-"+e,c),i.emit("received-"+e)})}),n&&(console.error("TOONE"),Lazy(n).each(function(t,e){console.log(e);g(e)})),o&&(console.error("TOMANY"),Lazy(o).each(function(t,e){e in ASKED_UNLINKED||(ASKED_UNLINKED[e]=Lazy([])),Lazy(t).each(function(t){ASKED_UNLINKED[e].source.push(t)})})),c&&(console.error("MANYTOMANY"),Lazy(c).each(function(t,e){var n=parseInt(e.split("|")[1]);e=e.split("|")[0],e in ASKED_M2M||(ASKED_M2M[e]=[{},{}]);var o=ASKED_M2M[e][n];Lazy(t).each(function(t){o[t+""]=!0,o[t]=!0})})),d&&r.gotM2M(d),u&&r.gotPermissions(u),e&&e(t),i.emit("got-data")}else if(console.log("data "+t+" refused from gotData()"),e)return e(t)},this.gotM2M=function(t){Lazy(t).each(function(t,e){var n=m.m2mIndex[e];Lazy(t).each(function(t){Lazy(t).each(function(t,e){n[e](t)})}),i.emit("received-m2m"),i.emit("received-m2m-"+e)})},this.fetch=function(t,e,n,o){t in h?setTimeout(function(){r.fetch(t,e,n,o)},500):r.describe(t,function(n){return r.connection.options.realtimeEndPoint?(e=y.filter(n,e),e?(h[t]=!0,r.$post(t+"/list",{filter:e},function(e){r.gotData(e,o),delete h[t]},function(){delete h[t]})):o&&o(),e):void this.$post(t+"/list",sendData,function(n){e||u.source.push(t),r.gotData(n,o)})})},this.get=function(t,e,n){e.constructor!==Array&&(e=[e]),r.fetch(t,{id:e},null,function(){var o=[],i=s[t];for(var r in e)o.push(i.source[e[r]]);n(o)})},this.gotModel=function(t){for(var e in t){var n=t[e];localStorage["description:"+e]=JSON.stringify(t),f[e]=z(n),e in s||(s[e]=Lazy({}))}},this.describe=function(t,e){var n=f[t];if(n)e&&e(n);else if(t in h)setTimeout(function(){r.describe(t,e)},500);else{if(t in p)return;var o="description:"+t;o in localStorage?(this.gotModel(JSON.parse(localStorage[o])),e&&e(f[t])):(h[t]=!0,this.$post(t+"/describe",null,function(n){r.gotModel(n),e&&e(f[t]),delete h[t]},function(e){this.events.modelNotFound.handle(t),p[t]=!0}))}},this.addBuilderHandler=function(t,e){var n=utils.hash(e);t in l||(l[t]=new Handler),t in d||(d[t]={}),l.addHandler(e),t in f&&(Lazy(d[t]).map(function(t){return t.toString()}).contains(e.toString())||(e.apply(this,[r.modelCache[t]]),d[t].push(n)))},this.connect=function(t){this.isConnected?t(this.connection.options):this.connection.connect(function(e){r.isConnected=!0,t(e)})},this.query=function(t,e,n,o){var i=utils.makeFilter(e),r=v(t);this.fetch(t,e,n,function(t){o(r.filter(i).values().toArray())})},this.delete=function(t,e,n){return this.$post(t+"/delete",{id:e},n)}};reWheelORM.prototype.get=function(t,e){var n=this,o=!1,i=t;return e.constructor!==Array&&(o=!0,e=[e]),new Promise(function(t,r){try{n.$orm.connect(function(){o?n.$orm.get(i,e,function(e){t(e[0])}):n.$orm.get(i,e,t)})}catch(t){r(t)}})},reWheelORM.prototype.query=function(t,e,n){var o=this;return new Promise(function(i,r){var s=null;n&&n.constructor===Array&&n.length?s=n:n&&n.constructor===String&&n.length&&(s=n.split(","));try{o.$orm.isConnected?o.$orm.query(t,e,s,i):o.$orm.connect(function(){o.$orm.query(t,e,s,i)})}catch(t){r(t)}})},reWheelORM.prototype.delete=function(t,e){var n=this;return new Promise(function(o,i){try{n.$orm.connected?n.$orm.delete(t,e,o):n.$orm.connect(function(){n.$orm.delete(t,e,o)})}catch(t){i(t)}})};