"use strict";function Handler(){this.handlers=[],this.strHandlers={}}function NamedEventManager(){var t={},n={},e=0;this.on=function(i,o){i in t||(t[i]=new Array);var r=e++;return t[i].push(o),n[r]=o,r},this.emit=function(n){if(n in t){var e=Array.prototype.slice.call(arguments,1);t[n].forEach(function(t){t.apply(null,e)})}},this.unbind=function(e){var i=0;if(e in n){var o=n[e+""];Lazy(t).each(function(t,n){var e=[];for(var r in t)t[r]===o&&(e.push(r),i++);e.reverse().forEach(function(n){t.splice(n,1)})})}return delete n[e],i}}function xdr(t,n,e,i,o,r){var s;n&&n.constructor===Object&&(n=JSON.stringify(n)),XMLHttpRequest?(s=new XMLHttpRequest,"withCredentials"in s&&(s.open("POST",t,!0),s.onerror=i,s.onreadystatechange=function(){if(4===s.readyState)if(s.status>=200&&s.status<400){try{var t=JSON.parse(s.responseText)}catch(t){var t=s.responseText}e(t,s.statusText,s)}else i(new Error("Response returned with non-OK status"))},o&&s.setRequestHeader("application",o),r&&s.setRequestHeader("token",r),s.setRequestHeader("Accept","application/json"),s.send(n))):XDomainRequest?(s=new XDomainRequest,s.open("POST",t),s.onerror=i,s.onload=function(){e(s.responseText,s.statusText,s)},o&&s.setRequestHeader("application",o),r&&s.setRequestHeader("token",r),s.send(n)):i(new Error("CORS not supported"))}function reWheelConnection(t,n){this.getLogin=n,this.events=new NamedEventManager,this.$POST=$POST.bind(this),this.options={endPoint:t},this.on=this.events.on.bind(this)}function Toucher(){var t=!1;this.touch=function(){t=!0},this.touched=function(){var n=t;return t=!1,n}}function VacuumCacher(t,n,e){if(!n)var n=[];var i=[];this.ask=function(e,o){Lazy(n).contains(e)||(i.push(e),o||n.push(e),t.touch())},this.getAskedIndex=function(){return n},this.missings=function(){return Lazy(i.splice(0,i.length)).unique().toArray()}}function ManyToManyRelation(t,n){var e=[];this.add=e.push.bind(e),this.add=function(t){console.log("adding "+t),Lazy(e).find(t)||e.push(t)},this["get"+utils.capitalize(t.indexName.split("/")[0])]=function(t){return n[1].ask(t),Lazy(e).filter(function(n){return n[0]===t}).pluck("1").toArray()},this["get"+utils.capitalize(t.indexName.split("/")[1])]=function(t){return n[0].ask(t),Lazy(e).filter(function(n){return n[1]===t}).pluck("0").toArray()},this.del=function(t){for(var n=e.length,i=null,o=0;o<n;o++)if(e[o][0]===t[0]&&e[o][1]===t[1]){i=o;break}i&&e.splice(o,1),console.log("deleting ",t)}}function AutoLinker(t,n,e,i,o){var r=new Toucher,s={},a={},c={},u={},l={};this.mainIndex=s,this.foreignKeys=a,this.m2m=c,this.m2mIndex=u,this.permissions=l,t.on("model-definition",function(t){var n=o.getIndexFor(t.name,"id");s[t.name]=new VacuumCacher(r,n,"mainIndex."+t.name),l[t.name]=new VacuumCacher(r,null,"permissions."+t.name),Lazy(t.references).each(function(n){var e=t.name+"_"+n.id;a[e]=new VacuumCacher(r,o.getIndexFor(n.to,"id"),n.to+".id foreignKeys."+e)}),Lazy(t.referencedBy).each(function(t){var n=t.by+"."+t.id;a[n]=new VacuumCacher(r,o.getIndexFor(t.by,t.id),t.by+"."+t.id+" foreignKeys."+n)}),Lazy(t.manyToMany).each(function(t){t.indexName in c||(c[t.indexName]=[new VacuumCacher(r,null,"m2m."+t.indexName+"[0]"),new VacuumCacher(r,null,"m2m."+t.indexName+"[1]")]),t.indexName in u||(u[t.indexName]=new ManyToManyRelation(t,c[t.indexName]))})});var d=function(t,e,o,r){Lazy(e).each(c[t][o].ask.bind(c[t][o])),e=c[t][o].missings(),e.length?(n[t]=1,i.$post((o?utils.reverse("/",t):t)+"s/list",{collection:e},function(e){i.gotData(e,r),delete n[t]})):r&&r()};this.getM2M=d;var f=function(){if(r.touched()){if(Lazy(n).values().sum())return void r.touch();var t=!1;Lazy(c).each(function(n,e){Lazy(n).each(function(n,i){var o=n.missings();if(o=Lazy(o).filter(function(t){return t}).map(function(t){return parseInt(t)}).toArray(),o.length){u[e];t=!0,d(e,o,i)}})}),Lazy(s).each(function(n,o){var r=n.missings();if(r.length){t=!0;o in e?e[o].keys():Lazy();i.fetch(o,{id:r},null,utils.noop)}}),Lazy(a).map(function(t,n){return[n,t.missings()]}).filter(function(t){return t[1].length}).each(function(n){t=!0;var e=n[1],o=n[0],r=o.split("."),s=r[0],a=r[1],c={};c[a]=e,i.fetch(s,c)})}};setInterval(f,50)}function cachedPropertyByEvents(t,n,e,i){var o=Array.prototype.slice.call(arguments,4),r={};Lazy(o).each(function(n){t.orm.on(n,function(){r={}})});var s={get:function(){return this.id in r||(r[this.id]=e.call(this)),r[this.id]}};i&&(s.set=function(t){t!==r[this.id]&&(i.call(this,t),this.id in r&&delete r[this.id])}),Object.defineProperty(t,n,s)}function ValidationError(t){this.resource=t._resource,this.formIdx=t.formIdx,this.fields=t.errors}function reWheelORM(t){this.$orm=new baseORM(t,this),this.on=this.$orm.on.bind(this.$orm)}Handler.prototype.addHandler=function(t){var n=utils.hash(t.toString());n in this.strHandlers||(this.strHandlers[n]=t,this.handlers.push(t))},Handler.prototype.handle=function(){var t=Array.prototype.slice.call(arguments,0);this.handlers.forEach(function(n){n.apply(null,t)})},Handler.prototype.handleBy=function(){var t=Array.prototype.slice.call(arguments,1),n=arguments[0];this.handlers.forEach(function(e){e.apply(n,t)})};var cachedKeyIdx=0,cached=function(t,n){function e(){return this[n]||(this[n]=t.call(this,[arguments])),this[n]}return n||(n="_"+cachedKeyIdx++),e},$POST=function(t,n,e,i,o){var r={accepts:"application/json",url:t,data:JSON.stringify(n),dataType:"json",success:e,error:i,method:"POST",contentType:"application/json"};return o&&(r.headers=o,r.crossDomain=!0),$.ajax(r)};reWheelConnection.prototype.status=function(t,n){if("lastRWTStatus"in localStorage&&!n){try{var e=JSON.parse(localStorage.lastRWTStatus);for(var i in e)this.options[i]=e[i]}catch(n){return this.status(t,!0)}return t&&t(e)}if(this._status_calling){var o=this;return setTimeout(function(){o.status(t)},50)}if(!this.options||!this.options.timestamp){this._status_calling=!0;var o=this;return this.$post("api/status",null,function(n){localStorage.lastRWTStatus=JSON.stringify(n),o._status_calling=!1;for(var e in n)o.options[e]=n[e];if(!n.user_id&&o.getLogin){var i=o.getLogin();i.constructor===Object&&o.login(i.username,i.password).then(function(n){for(var e in n)o.options[e]=n[e];localStorage.lastRWTStatus=JSON.stringify(n),t&&t(n)})}else t&&t(o.options)})}t&&t(this.options)},reWheelConnection.prototype.$post=function(t,n,e){var i=this;if(this.options&&this.options.token&&(n||(n={})),this.options.token){({token:this.options.token,application:this.options.application})}else;var o=xdr(this.options.endPoint+t,n,function(o,r,s){i.events.emit("http-response",o,s.status,t,n),i.events.emit("http-response-"+s.status,o,t,n),e&&e(o)},function(e){try{var o=JSON.parse(e.responseText);i.events.emit("error-json",o,e.status,t,n,e),i.events.emit("error-json-"+e.status,o,t,n,e)}catch(o){i.events.emit("error-http",e.responseText,e.status,t,n,e),i.events.emit("error-http-"+e.status,e.responseText,t,n,e)}},this.options.application,this.options.token);return o},reWheelConnection.prototype.login=function(t,n){var e=this.options.endPoint+"api/login",i=this,o=null;return this.options.token&&(o={token:this.options.token}),new Promise(function(o,r){$.ajax({url:e,data:{username:t,password:n},dataType:"json",method:"POST",mimeType:"application/json",crossDomain:!0,success:function(t){for(var n in t)i.options[n]=t[n];o(t)},error:function(t,n,e){r(t.responseJSON)}})})},reWheelConnection.prototype.connect=function(t){var n=this,e=function(t){t.wsConnection=new utils.wsConnect(t.options),t.wsConnection.onConnect(function(){t.events.emit("ws-connected",t.wsConnection)}),t.wsConnection.onDisconnect(function(){setTimeout(function(){e(t)},1e3)})};return this.status(function(i){"token"in n.options?t&&t(i):(console.log("connecting to "+n.options.endPoint),n.options.username&&n.options.password&&n.login(n.options.username,n.options.password,function(n){t&&t(n),console.log("renewing connection")})),i.token&&i.realtimeEndPoint&&!n.wsConnection&&e(n)})};var utils={renameFunction:function(t,n){return new Function("return function (call) { return function "+t+" () { return call(this, arguments) }; };")()(Function.apply.bind(n))},log:function(){console.log(arguments)},setToParent:function(t,n,e){if(n in t){for(var i=t,o=i;i&&n in i;)o=i,i=i.$parent;n in o&&(o[n]=e)}},capitalize:function(t){return t[0].toUpperCase()+t.slice(1).toLowerCase()},hash:function(t){t=t.toString();for(var n=1,e=0;e<t.length;e++)n*=1+t.charCodeAt(e);return(n%34958374957).toString()},makeListCacheKey:function(t,n){return JSON.stringify(Lazy(t).map(function(t,n){return[n,Lazy(t).map(function(t){return t+""}).sort().toArray()]}).toObject())},makeFilter:function(t,n){var e=Lazy(n).map(function(n,e){if(n.constructor==Array)n=Lazy(n).map(function(t){return[t,1]}).toObject();else if(isFinite(n)||"Number"==typeof n){var i={};i[n]=1,n=i}return Lazy(t.references).contains(e)&&(e="_"+e),[e,n]}).toObject();return function(t){return Lazy(e).all(function(n,e){return t[e]in n})}},sameAs:function(t,n){for(var e in t)if(n[e]!=t[e])return!1;return!0},wsConnect:function(t){if(t){var n=this;this.handlers={wizard:new Handler,onConnection:new Handler,onDisconnection:new Handler,onMessageJson:new Handler,onMessageText:new Handler},this.onWizard=this.handlers.wizard.addHandler.bind(this.handlers.wizard),this.onConnect=this.handlers.onConnection.addHandler.bind(this.handlers.onConnection),this.onDisconnect=this.handlers.onDisconnection.addHandler.bind(this.handlers.onDisconnection),this.onMessageJson=this.handlers.onMessageJson.addHandler.bind(this.handlers.onMessageJson),this.onMessageText=this.handlers.onMessageText.addHandler.bind(this.handlers.onMessageText),this.options=t;var e=new SockJS(t.realtimeEndPoint);e.onopen=function(t){console.log("open : "+t),e.tenant(),n.handlers.onConnection.handle(t)},e.onmessage=function(t){if("message"==t.type)try{n.handlers.onMessageJson.handle($.parseJSON(t.data))}catch(e){n.handlers.onMessageText.handle(t.data)}else console.log(t)},e.onclose=function(){setTimeout(utils.wsConnect,1e3),n.handlers.onDisconnection.handle()},e.tenant=function(){e.send("TENANT:"+n.options.application+":"+n.options.token)}}},pluralize:function(t,n){return t+"s"},beforeCall:function(t,n){var e=function(){n().then(t)};return e},cleanStorage:function(){Lazy(localStorage).keys().each(function(t){delete localStorage[t]})},reverse:function(t,n){return n.split(t).reverse().join(t)},bool:Boolean,noop:function(){}},tzOffset=6e4*(new Date).getTimezoneOffset(),findControllerScope=function(t){for(var n=t,e=void 0,i=!0,o=Lazy(Lazy(t).find(function(t,n){return t&&t.constructor.$inject}).constructor.$inject);n;){i=!1;var r=Lazy(n).find(function(t,n){return t&&t.constructor.$inject});if(r&&(i=0==o.difference(r.constructor.$inject).size()),!i)return e||t.$parent;e=n,n=n.$parent}return t.$parent},findControllerAs=function(t,n){for(var e=t;e;){var i=n(e);if(i)return e;e=e.$parent}},ListCacher=function(){var t={},n={};this.filter=function(e,i){var o=this.getIndexFor,r=e.modelName;if(r in t)return null;if(0==Lazy(i).size())return t[r]=!0,r in n&&delete n[r],{};var s=Lazy(i).map(function(t,n){return[n,r+"."+n]}).toObject(),a=Lazy(i).keys().map(function(t){return[t,o(r,t)]}).toObject(),c=Lazy(i).map(function(t,e){return[e,Lazy(t).difference(n[s[e]]).unique().toArray()]}).filter(function(t){return t[1].length}).toObject();return Lazy(c).size()?(Lazy(i).each(function(t,e){var i=Lazy(t).difference(a[e]).toArray();i.length&&Array.prototype.push.apply(n[r+"."+e],t)}),c):null},this.getIndexFor=function(t,e){var i=t+"."+e;return i in n||(n[i]=[]),n[i]}},baseORM=function(t,n){function e(t,n,e){this.klass=n,this.permissions=[],this.id=t;for(var i in e)this.push.apply(this,[i,e[i]])}if(t.constructor===String)var i=new reWheelConnection(t);else if(t.constructor===reWheelConnection)var i=t;this.connection=i,i.on("connected",function(){this.connected=!0});var o=i.events;this.on=o.on.bind(this),this.emit=o.emit.bind(this),this.$post=i.$post.bind(i),o.on("ws-connected",function(t){console.info("Websocket connected"),t.onMessageJson(r.gotData.bind(r)),t.onMessageText(function(t){console.info("WS message : "+t)})}),o.on("ws-disconnected",function(t){console.error("Websocket disconnected")}),o.on("error-json-404",function(t,n,e,i){console.error("JSON error ",JSON.stringify(t)),delete p[n.split("/")[0]]});var r=this,s={auth_group:Lazy({})};window.DB=s;var a={},c={},u=Lazy([]),l={},d={},f={},h={},p={},y=new ListCacher,m=new AutoLinker(o,p,s,this,y);window.ll=m,window.lc=y,this.validationEvent=o.on("error-json-513",function(t,n,e,i){currentContext.savingErrorHanlder&&currentContext.savingErrorHanlder(new ValidationError(t))});var v=function(t){return t in s?s[t]:(s[t]=Lazy({}),s[t])},g=function(t){return t in UNLINKED?UNLINKED[t]:(UNLINKED[t]={},UNLINKED[t])};e.prototype.save=function(t){var n={permissions:Lazy(this.permissions).map(function(t){return[t[0].id,t[1]]}).toObject()};n.id=this.id;this.klass.modelName;W2P_POST(this.klass.modelName,"set_permissions",n,function(n,e,i,o){t(n)})},e.prototype.push=function(t,n){var e=Lazy(n),i=Lazy(this.klass.allPermissions).map(function(t){return[t,e.contains(t)]}).toObject(),o=Lazy(this.permissions).map(function(t){return t[0].id});o.contains(t)?this.permissions[o.indexOf(t)][1]=i:this.permissions.push([s.auth_group.get(t),i])};var z=function(t){var i=Lazy(t.fields);t.privateArgs&&(i=i.merge(t.privateArgs)),r.emit("model-definition",t);var u="if (!row) { row = {}};\n";u+=t.references.map(function(t){return"this._"+t.id+" = row."+t.id+";"}).join(";\n"),u+=i.map(function(t,n){return"date"==t.type||"datetime"==t.type?"this."+n+" = row."+n+"?new Date(row."+n+" * 1000 - tzOffset):null;\n":"boolean"==t.type?"this."+n+" = (row."+n+' === "T") || (row.'+n+" === true);\n":"this."+n+" = row."+n+";\n"}).toString("\n"),u+="if (permissions) {this._permissions = permissions && Lazy(permissions).map(function (x) { return [x, true] }).toObject();}";var h=new Function("row","permissions",u);h.prototype.orm=n,h.ref_translations={},h.modelName=t.name,h.references=Lazy(t.references).pluck("id").toArray(),h.inverse_references=t.referencedBy.map(function(t){return t.by+"_"+t.id+"_set"}),h.referents=t.referencedBy.map(function(t){return[t.by,t.id]}),h.fieldsOrder=t.fieldOrder,h.allPermissions=t.permissions,Lazy(t.representation).size()&&(h.prototype.toString=new Function("return this."+Lazy(t.representation).toString(' + " " + this.'))),h.prototype.toUpperCase=function(){return this.toString().toUpperCase()},h.prototype.toLowerCase=function(){return this.toString().toLowerCase()},h.prototype.delete=function(){return n.delete(this.constructor.modelName,[this.id])},h.prototype.all_perms=function(t){var n=this.id;rewheel.$post(this.constructor.modelName,"all_perms",{id:this.id},function(i){var o=i,r={},a=Lazy(o).pluck("group_id").unique().map(function(t){return""+t}).difference(s.auth_group.keys()).toArray();Lazy(o).groupBy(function(t){return t.group_id}).each(function(t,n){r[n]=Lazy(t).pluck("name").toArray()});var c=function(i){t(new e(n,h,r))};a.length?rewheel.$get("auth_group",a,void 0,c):c()})},h.prototype.save=function(t){if(t)for(var n in t)this[n]=t[n];var e={},i=this.asRaw();this.field;Lazy(this.constructor.fields).each(function(t){var n=h.privateArgs||{};"M2M"==t.type||!t.writable||t.id in n||(e[t.id]=i[t.id])});var o=r.$post(this.constructor.modelName+(this.id?"/post":"/put"),e);t&&t.constructor===Function&&(o.context.savingErrorHanlder=t)},h.prototype.copy=function(){var t=new this.constructor(this.asRaw());return t.permissions=this.permissions,t};var p="return {\n"+Lazy(t.references).map(function(t){return t.id+" : this._"+t.id}).concat(i.map(function(t,n){return"date"==t.type||"datetime"==t.type?n+" : (this."+n+"?(Math.round(this."+n+".getTime() - this."+n+".getTimezoneOffset() * 60000) / 1000):null)":"boolean"==t.type?n+" : this."+n+'?"T":"F"':n+" : this."+n})).toString(",\n")+"};";h.prototype.asRaw=new Function(p),h.saveMulti=function(t,n,e){var i=[],o=Lazy(h.fields).filter(function(t){return!t.writable}).pluck("id").toArray();Lazy(t).map(function(t){return t.asRaw()}).each(function(t){Lazy(o).each(function(n){delete t[n]}),i.push(t)}),r.$post(h.modelName,"put",{multiple:i,formIdx:r.formIdx++},function(t){r.gotData(t);var e=s[h.modelName],i=Lazy(t[h.modelName].results).pluck("id").map(function(t){return e.get(t)}).toArray();n&&n(i)},e)},"extra_verbs"in t&&Lazy(t.extra_verbs).each(function(t){var n=t[0],e=t[1],i="data = {id : this.id";e.length&&(i+=", "+Lazy(e).map(function(t){return t+" : "+t}).join(",")),i+="};",e.push("cb"),h.prototype[n]=new Function(e,i+'W2S.W2P_POST(this.constructor.modelName,"'+n+'", data,function(data,status,headers,x){try{\n   if (!headers("nomodel")) {window.W2S.gotData(data,cb);}\n   else {if (cb) {cb(data)}}\n} catch(e){\nif (cb) {cb(data);}\n}\n});\n')}),"privateArgs"in t&&(h.privateArgs=Lazy(t.privateArgs).keys().map(function(t){return[t,!0]}).toObject(),h.prototype.savePA=function(t){var n=this,e={id:this.id},i=this.constructor.privateArgs,o=this.constructor.fields,s=(new this.constructor(t).asRaw(),Lazy(i).keys().map(function(t){return[t,o[t]]}).toObject());Lazy(t).each(function(t,n){n in i&&s[n].writable&&(e[n]=t)}),r.$post(this.constructor.modelName+"/savePA",e,function(){Lazy(e).each(function(t,e){n[e]=t})})}),f[h.modelName]=h;for(var y in t.fields)t.fields[y].id=y;if(h.fields=Lazy(t.fields).concat(Lazy(t.privateArgs)).concat(Lazy(t.references).tap(function(t){t.type=t.type||"reference"})).indexBy("id").toObject(),Lazy(t.references).each(function(t){var e=t.to,i="_"+t.id;cachedPropertyByEvents(h.prototype,t.id,function(){e in s||r.describe(e);var t=e in s&&this[i]&&s[e].get(this[i]);return t?t:m.mainIndex[e].ask(this[i],!0)},function(n){if(n&&n.constructor.modelName!=e)throw new TypeError("You can assign only "+e+" to "+t.id);this[i]=n.id},"new-"+e,"deleted-"+e),h.prototype["get"+utils.capitalize(t.id)]=function(){return n.get(e,this[i])}}),Lazy(t.referencedBy).each(function(t){var e=t.by+"."+t.id,i=t.by+"_"+utils.pluralize(t.id),o=t.by;h.prototype.hasOwnProperty(i)?$log.error("Tryed to redefine property "+i+"s for "+h.modelName):cachedPropertyByEvents(h.prototype,i,function(){var t=o in s?a[e].get(this.id+""):null;return m.foreignKeys[e].ask(this.id,!0),t},null,"new-"+o,"updated-"+o,"deleted-"+o),h.prototype["get"+utils.capitalize(utils.pluralize(t.by))]=function(){var e={};return e[t.id]=[this.id],n.query(t.by,e)}}),t.manyToMany&&(Lazy(t.manyToMany).each(function(t){var n=t.indexName,e=t.first?0:1,i=t.model,o=m.m2mIndex[n]["get"+utils.capitalize(i)];cachedPropertyByEvents(h.prototype,t.model+"s",function(){var t=this,a=[],c=null,u=null;return m.getM2M(n,[t.id],e,function(n){c=o(t.id),c.length&&(r.fetch(i,{id:c}),u=s[i].get.bind(s[i]))}),c&&u&&(a=Lazy(c).map(u).filter(utils.bool).toArray()),a},null,"received-m2m-"+n),h.prototype["get"+utils.capitalize(utils.pluralize(i))]=function(){var t=this;return new Promise(function(a,c){try{m.getM2M(n,[t.id],e,function(n){var e=o(t.id);e.length?r.fetch(i,{id:e},null,function(){var t=s[i].get.bind(s[i]);a(Lazy(e).map(t).filter(utils.bool).toArray())}):a([])})}catch(t){console.error(t),c(t)}})},h.fields[utils.capitalize(i)]={id:utils.capitalize(i),name:utils.capitalize(i),writable:!0,readable:!0,type:"M2M",validators:[]}}),h.prototype.unlinkReference=function(t){var n=!1,e=this.id,i=[];"Array"==t.constructor.name&&(n=!0,i=t,t=i[0]);var o=t.constructor.modelName;if(n)var s=Lazy(i).pluck("id").map(function(t){return[e,t]}).toArray();else var s=[[e,t.id]];r.$post(h.modelName+"/"+o+"s/delete",{collection:s})},h.prototype.linkReference=function(t){var n=!1,e=this.id,i=[];"Array"==t.constructor.name&&(n=!0,i=t,t=i[0]);var o=t.constructor.modelName,s=h.modelName+"/"+o;if(n){var a=[];if(s in c&&(a=Lazy(i).pluck("id").difference(Lazy(c[s][0].get(this.id))).toArray()),s=o+"/"+h.modelName,s in c&&(a=Lazy(i).pluck("id").difference(Lazy(c[s][0].get(this.id))).toArray()),a.length){var u=Lazy(a).map(function(t){return[e,t]}).toArray();W2P_POST(h.modelName,o+"s/put",{collection:u},function(t){})}}else{if(s in m.m2mIndex&&Lazy(m.m2mIndex[s]["get"+utils.capitalize(o)](t.id)).find(this))return;r.$post(h.modelName+"/"+o+"s/put",{collection:[[this.id,t.id]]})}}),h.modelName in l)for(;l[h.modelName].length;){var v=l[h.modelName].pop();Lazy(d[h.modelName]).map(function(t){return t.toString()}).contains(v.toString())||(v(h),d[h.modelName].push(v))}return o.emit("new-model",h),h};this.gotData=function(t,n){if(console.info("gotData"),"string"!=typeof t){"_extra"in t&&delete t._extra;var e=t.TOONE,i=t.TOMANY,c=t.MANYTOMANY,u=t.PERMISSIONS,l=t.PA;if(delete t.TOONE,delete t.TOMANY,delete t.MANYTOMANY,delete t.PERMISSIONS,delete t.PA,l||(l={}),t=Lazy(t).filter(function(t,n){return!("deleted"in t)||n in r.modelCache}).toObject(),"m2m"in t){var d=t.m2m;delete t.m2m}Lazy(t).each(function(t,n){r.describe(n,function(e){var i=e;t.results&&t.results.length>0&&t.results[0].constructor==Array&&(t.results=Lazy(t.results).map(function(t){return Lazy(i.fieldsOrder).zip(t).toObject()}).toArray());var r=Lazy(t.results),c=t.deleted;if(n in l){var u=l[n];Lazy(r).each(function(t){t.id in u&&Lazy(u[t.id]).each(function(n,e){t[e]=n})})}var d=v(n),h=d.source;c&&c.forEach(function(t){delete h[t]});var p=r.indexBy("id"),y=p.keys(),m=y.difference(d.keys().map(function(t){return parseInt(t)})),g=y.difference(m);g=g.filter(function(t){return!utils.sameAs(p.get(t),d.get(t).asRaw())});var z=t.permissions?Lazy(t.permissions):Lazy({}),L=m.map(function(t){return new i(p.get(t),z.get(t))}),w=[];g.each(function(t){var n=d.get(t),o=n.copy(),r=new i(p.get(t));Lazy(e.fields).keys().each(function(t){n[t]=r[t]}),w.push([n,o])}),w.length&&o.emit("updated-"+n,w);var N=L.toArray();Lazy(N).each(function(t){h[t.id]=t}),Lazy(f[n].references).each(function(t){a[n+"."+t]=s[n].groupBy("_"+t)}),N.length&&o.emit("new-"+n,Lazy(N),t.totalResults),c&&o.emit("deleted-"+n,c),o.emit("received-"+n)})}),e&&(console.error("TOONE"),Lazy(e).each(function(t,n){console.log(n);g(n)})),i&&(console.error("TOMANY"),Lazy(i).each(function(t,n){n in ASKED_UNLINKED||(ASKED_UNLINKED[n]=Lazy([])),Lazy(t).each(function(t){ASKED_UNLINKED[n].source.push(t)})})),c&&(console.error("MANYTOMANY"),Lazy(c).each(function(t,n){var e=parseInt(n.split("|")[1]);n=n.split("|")[0],n in ASKED_M2M||(ASKED_M2M[n]=[{},{}]);var i=ASKED_M2M[n][e];Lazy(t).each(function(t){i[t+""]=!0,i[t]=!0})})),d&&r.gotM2M(d),u&&r.gotPermissions(u),n&&n(t),o.emit("got-data")}else if(console.log("data "+t+" refused from gotData()"),n)return n(t)},this.gotM2M=function(t){Lazy(t).each(function(t,n){var e=m.m2mIndex[n];Lazy(t).each(function(t){Lazy(t).each(function(t,n){e[n](t)})}),o.emit("received-m2m"),o.emit("received-m2m-"+n)})},this.fetch=function(t,n,e,i){t in p?setTimeout(function(){r.fetch(t,n,e,i)},500):r.describe(t,function(e){return r.connection.options.realtimeEndPoint?(n=y.filter(e,n),n?(p[t]=!0,r.$post(t+"/list",{filter:n},function(n){r.gotData(n,i),delete p[t]},function(){delete p[t]})):i&&i(),n):void this.$post(t+"/list",sendData,function(e){n||u.source.push(t),r.gotData(e,i)})})},this.get=function(t,n,e){n.constructor!==Array&&(n=[n]),r.fetch(t,{id:n},null,function(){var i=[],o=s[t];for(var r in n)i.push(o.get(r));e(i)})},this.gotModel=function(t){for(var n in t){var e=t[n];localStorage["description:"+n]=JSON.stringify(t),f[n]=z(e),n in s||(s[n]=Lazy({}))}},this.describe=function(t,n){var e=f[t];if(e)n&&n(e);else if(t in p)setTimeout(function(){r.describe(t,n)},500);else{if(t in h)return;var i="description:"+t;i in localStorage?(this.gotModel(JSON.parse(localStorage[i])),n&&n(f[t])):(p[t]=!0,this.$post(t+"/describe",null,function(e){r.gotModel(e),n&&n(f[t]),delete p[t]},function(n){this.events.modelNotFound.handle(t),h[t]=!0}))}},this.addBuilderHandler=function(t,n){var e=utils.hash(n);t in l||(l[t]=new Handler),t in d||(d[t]={}),l.addHandler(n),t in f&&(Lazy(d[t]).map(function(t){return t.toString()}).contains(n.toString())||(n.apply(this,[r.modelCache[t]]),d[t].push(e)))},this.connect=function(t){this.isConnected?t(this.connection.options):this.connection.connect(function(n){r.isConnected=!0,t(n)})},this.query=function(t,n,e,i){var o=utils.makeFilter(n),r=v(t);this.fetch(t,n,e,function(t){i(r.filter(o).values().toArray())})},this.delete=function(t,n,e){return this.$post(t+"/delete",{id:n},e)}};reWheelORM.prototype.get=function(t,n){var e=this,i=!1,o=t;return n.constructor!==Array&&(i=!0,n=[n]),new Promise(function(t,r){try{e.$orm.connect(function(){i?e.$orm.get(o,n,function(n){t(n[0])}):e.$orm.get(o,n,t)})}catch(t){r(t)}})},reWheelORM.prototype.query=function(t,n,e){var i=this;return new Promise(function(o,r){var s=null;e&&e.constructor===Array&&e.length?s=e:e&&e.constructor===String&&e.length&&(s=e.split(","));try{i.$orm.isConnected?i.$orm.query(t,n,s,o):i.$orm.connect(function(){i.$orm.query(t,n,s,o)})}catch(t){r(t)}})},reWheelORM.prototype.delete=function(t,n){var e=this;return new Promise(function(i,o){try{e.$orm.connected?e.$orm.delete(t,n,i):e.$orm.connect(function(){e.$orm.delete(t,n,i)})}catch(t){o(t)}})};