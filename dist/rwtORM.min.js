"use strict";function Handler(){this.handlers=[],this.strHandlers={}}function NamedEventManager(){var n={},t={},e=0;this.on=function(i,o){i in n||(n[i]=new Array);var r=e++;return n[i].push(o),t[r]=o,r},this.emit=function(t){if(t in n){var e=Array.prototype.slice.call(arguments,1);n[t].forEach(function(n){n.apply(null,e)})}},this.unbind=function(e){var i=0;if(e in t){var o=t[e+""];Lazy(n).each(function(n,t){var e=[];for(var r in n)n[r]===o&&(e.push(r),i++);e.reverse().forEach(function(t){n.splice(t,1)})})}return delete t[e],i}}function xdr(n,t,e,i,o,r){var s;t&&t.constructor===Object&&(t=JSON.stringify(t)),XMLHttpRequest?(s=new XMLHttpRequest,"withCredentials"in s&&(s.open("POST",n,!0),s.onerror=i,s.onreadystatechange=function(){if(4===s.readyState)if(s.status>=200&&s.status<400){try{var n=JSON.parse(s.responseText)}catch(n){var n=s.responseText}e(n,s.statusText,s)}else i(new Error("Response returned with non-OK status"))},o&&s.setRequestHeader("application",o),r&&s.setRequestHeader("token",r),s.setRequestHeader("Accept","application/json"),s.send(t))):XDomainRequest?(s=new XDomainRequest,s.open("POST",n),s.onerror=i,s.onload=function(){e(s.responseText,s.statusText,s)},o&&s.setRequestHeader("application",o),r&&s.setRequestHeader("token",r),s.send(t)):i(new Error("CORS not supported"))}function reWheelConnection(n,t){this.getLogin=t,this.events=new NamedEventManager,this.$POST=$POST.bind(this),this.options={endPoint:n},this.on=this.events.on.bind(this)}function Toucher(){var n=!1;this.touch=function(){n=!0},this.touched=function(){var t=n;return n=!1,t}}function VacuumCacher(n,t,e){if(!t)var t=[];var i=[];this.ask=function(e,o){Lazy(t).contains(e)||(i.push(e),o||t.push(e),n.touch())},this.getAskedIndex=function(){return t},this.missings=function(){return Lazy(i.splice(0,i.length)).unique().toArray()}}function ManyToManyRelation(n,t){var e=[];this.add=e.push.bind(e),this.add=function(n){console.log("adding "+n),Lazy(e).find(n)||e.push(n)},this["get"+utils.capitalize(n.indexName.split("/")[0])]=function(n){return t[1].ask(n),Lazy(e).filter(function(t){return t[0]===n}).pluck("1").toArray()},this["get"+utils.capitalize(n.indexName.split("/")[1])]=function(n){return t[0].ask(n),Lazy(e).filter(function(t){return t[1]===n}).pluck("0").toArray()},this.del=function(n){for(var t=e.length,i=null,o=0;o<t;o++)if(e[o][0]===n[0]&&e[o][1]===n[1]){i=o;break}i&&e.splice(o,1),console.log("deleting ",n)}}function AutoLinker(n,t,e,i,o){var r=new Toucher,s={},a={},c={},u={},l={};this.mainIndex=s,this.foreignKeys=a,this.m2m=c,this.m2mIndex=u,this.permissions=l,n.on("model-definition",function(n){var t=o.getIndexFor(n.name,"id");s[n.name]=new VacuumCacher(r,t,"mainIndex."+n.name),l[n.name]=new VacuumCacher(r,null,"permissions."+n.name),Lazy(n.references).each(function(t){var e=n.name+"_"+t.id;a[e]=new VacuumCacher(r,o.getIndexFor(t.to,"id"),t.to+".id foreignKeys."+e)}),Lazy(n.referencedBy).each(function(n){var t=n.by+"."+n.id;a[t]=new VacuumCacher(r,o.getIndexFor(n.by,n.id),n.by+"."+n.id+" foreignKeys."+t)}),Lazy(n.manyToMany).each(function(n){n.indexName in c||(c[n.indexName]=[new VacuumCacher(r,null,"m2m."+n.indexName+"[0]"),new VacuumCacher(r,null,"m2m."+n.indexName+"[1]")]),n.indexName in u||(u[n.indexName]=new ManyToManyRelation(n,c[n.indexName]))})});var f=function(n,e,o,r){Lazy(e).each(c[n][o].ask.bind(c[n][o])),e=c[n][o].missings(),e.length?(t[n]=1,i.$post((o?utils.reverse("/",n):n)+"s/list",{collection:e},function(e){i.gotData(e,r),delete t[n]})):r&&r()};this.getM2M=f;var d=function(){if(r.touched()){if(Lazy(t).values().sum())return void r.touch();var n=!1;Lazy(c).each(function(t,e){Lazy(t).each(function(t,i){var o=t.missings();if(o=Lazy(o).filter(function(n){return n}).map(function(n){return parseInt(n)}).toArray(),o.length){u[e];n=!0,f(e,o,i)}})}),Lazy(s).each(function(t,o){var r=t.missings();if(r.length){n=!0;o in e?e[o].keys():Lazy();i.fetch(o,{id:r},null,utils.noop)}}),Lazy(a).map(function(n,t){return[t,n.missings()]}).filter(function(n){return n[1].length}).each(function(t){n=!0;var e=t[1],o=t[0],r=o.split("."),s=r[0],a=r[1],c={};c[a]=e,i.fetch(s,c)})}};setInterval(d,50)}function cachedPropertyByEvents(n,t,e,i){var o=Array.prototype.slice.call(arguments,4),r={};Lazy(o).each(function(t){n.orm.on(t,function(){r={}})});var s={get:function(){return this.id in r||(r[this.id]=e.call(this)),r[this.id]}};i&&(s.set=function(n){n!==r[this.id]&&(i.call(this,n),this.id in r&&delete r[this.id])}),Object.defineProperty(n,t,s)}function ValidationError(n){this.resource=n._resource,this.formIdx=n.formIdx,this.fields=n.errors}function reWheelORM(n){this.$orm=new baseORM(n,this),this.on=this.$orm.on.bind(this.$orm)}Handler.prototype.addHandler=function(n){var t=utils.hash(n.toString());t in this.strHandlers||(this.strHandlers[t]=n,this.handlers.push(n))},Handler.prototype.handle=function(){var n=Array.prototype.slice.call(arguments,0);this.handlers.forEach(function(t){t.apply(null,n)})},Handler.prototype.handleBy=function(){var n=Array.prototype.slice.call(arguments,1),t=arguments[0];this.handlers.forEach(function(e){e.apply(t,n)})};var cachedKeyIdx=0,cached=function(n,t){function e(){return this[t]||(this[t]=n.call(this,[arguments])),this[t]}return t||(t="_"+cachedKeyIdx++),e},$POST=function(n,t,e,i,o){var r={accepts:"application/json",url:n,data:JSON.stringify(t),dataType:"json",success:e,error:i,method:"POST",contentType:"application/json"};return o&&(r.headers=o,r.crossDomain=!0),$.ajax(r)};reWheelConnection.prototype.status=function(n,t){if("lastRWTStatus"in localStorage&&!t){try{var e=JSON.parse(localStorage.lastRWTStatus);for(var i in e)this.options[i]=e[i]}catch(t){return this.status(n,!0)}return n&&n(e)}if(this._status_calling){var o=this;return setTimeout(function(){o.status(n)},50)}if(!this.options||!this.options.timestamp){this._status_calling=!0;var o=this;return this.$post("api/status",null,function(t){localStorage.lastRWTStatus=JSON.stringify(t),o._status_calling=!1;for(var e in t)o.options[e]=t[e];if(!t.user_id&&o.getLogin){var i=o.getLogin();i.constructor===Object&&o.login(i.username,i.password).then(function(t){for(var e in t)o.options[e]=t[e];localStorage.lastRWTStatus=JSON.stringify(t),n&&n(t)})}else n&&n(o.options)})}n&&n(this.options)},reWheelConnection.prototype.$post=function(n,t,e){var i=this;if(this.options&&this.options.token&&(t||(t={})),this.options.token){({token:this.options.token,application:this.options.application})}else;var o=xdr(this.options.endPoint+n,t,function(o,r,s){i.events.emit("http-response",o,s.status,n,t),i.events.emit("http-response-"+s.status,o,n,t),e&&e(o)},function(e){try{var o=JSON.parse(e.responseText);i.events.emit("error-json",o,e.status,n,t,e),i.events.emit("error-json-"+e.status,o,n,t,e)}catch(o){i.events.emit("error-http",e.responseText,e.status,n,t,e),i.events.emit("error-http-"+e.status,e.responseText,n,t,e)}},this.options.application,this.options.token);return o},reWheelConnection.prototype.login=function(n,t){var e=this.options.endPoint+"api/login",i=this,o=null;return this.options.token&&(o={token:this.options.token}),new Promise(function(o,r){$.ajax({url:e,data:{username:n,password:t},dataType:"json",method:"POST",mimeType:"application/json",crossDomain:!0,success:function(n){for(var t in n)i.options[t]=n[t];o(n)},error:function(n,t,e){r(n.responseJSON)}})})},reWheelConnection.prototype.connect=function(n){var t=this,e=function(n){n.wsConnection=new utils.wsConnect(n.options),n.wsConnection.onConnect(function(){n.events.emit("ws-connected",n.wsConnection)}),n.wsConnection.onDisconnect(function(){setTimeout(function(){e(n)},1e3)})};return this.status(function(i){"token"in t.options?n&&n(i):(console.log("connecting to "+t.options.endPoint),t.options.username&&t.options.password&&t.login(t.options.username,t.options.password,function(t){n&&n(t),console.log("renewing connection")})),i.token&&i.realtimeEndPoint&&!t.wsConnection&&e(t)})};var utils={renameFunction:function(n,t){return new Function("return function (call) { return function "+n+" () { return call(this, arguments) }; };")()(Function.apply.bind(t))},log:function(){console.log(arguments)},setToParent:function(n,t,e){if(t in n){for(var i=n,o=i;i&&t in i;)o=i,i=i.$parent;t in o&&(o[t]=e)}},capitalize:function(n){return n[0].toUpperCase()+n.slice(1).toLowerCase()},hash:function(n){n=n.toString();for(var t=1,e=0;e<n.length;e++)t*=1+n.charCodeAt(e);return(t%34958374957).toString()},makeListCacheKey:function(n,t){return JSON.stringify(Lazy(n).map(function(n,t){return[t,Lazy(n).map(function(n){return n+""}).sort().toArray()]}).toObject())},makeFilter:function(n,t){if(0===Lazy(t).size())return function(n){return!0};var e=Lazy(t).map(function(t,e){return t.constructor!==Array&&(t=[t]),"reference"===n.fields[e].type&&(e="_"+e,t=Lazy(t).filter(Boolean).map(function(n){return n.constructor!==Number?n.id:n}).toArray()),"("+Lazy(t).map(function(n){return"(x."+e+" === "+n+")"}).join(" || ")+")"}).toArray().join(" && ");return new Function("x","return "+e)},sameAs:function(n,t){for(var e in n)if(t[e]!=n[e])return!1;return!0},wsConnect:function(n){if(n){var t=this;this.handlers={wizard:new Handler,onConnection:new Handler,onDisconnection:new Handler,onMessageJson:new Handler,onMessageText:new Handler},this.onWizard=this.handlers.wizard.addHandler.bind(this.handlers.wizard),this.onConnect=this.handlers.onConnection.addHandler.bind(this.handlers.onConnection),this.onDisconnect=this.handlers.onDisconnection.addHandler.bind(this.handlers.onDisconnection),this.onMessageJson=this.handlers.onMessageJson.addHandler.bind(this.handlers.onMessageJson),this.onMessageText=this.handlers.onMessageText.addHandler.bind(this.handlers.onMessageText),this.options=n;var e=new SockJS(n.realtimeEndPoint);e.onopen=function(n){console.log("open : "+n),e.tenant(),t.handlers.onConnection.handle(n)},e.onmessage=function(n){if("message"==n.type)try{t.handlers.onMessageJson.handle($.parseJSON(n.data))}catch(e){t.handlers.onMessageText.handle(n.data)}else console.log(n)},e.onclose=function(){setTimeout(utils.wsConnect,1e3),t.handlers.onDisconnection.handle()},e.tenant=function(){e.send("TENANT:"+t.options.application+":"+t.options.token)}}},pluralize:function(n,t){return n+"s"},beforeCall:function(n,t){var e=function(){t().then(n)};return e},cleanStorage:function(){Lazy(localStorage).keys().each(function(n){delete localStorage[n]})},reverse:function(n,t){return t.split(n).reverse().join(n)},permutations:function(n){for(var t=[],e=n.length-1;e>=0;e--)for(var i=n.length-1;i>=0;i--)e!==i&&t.push([n[e],n[i]]);return t},bool:Boolean,noop:function(){}},tzOffset=6e4*(new Date).getTimezoneOffset(),findControllerScope=function(n){for(var t=n,e=void 0,i=!0,o=Lazy(Lazy(n).find(function(n,t){return n&&n.constructor.$inject}).constructor.$inject);t;){i=!1;var r=Lazy(t).find(function(n,t){return n&&n.constructor.$inject});if(r&&(i=0==o.difference(r.constructor.$inject).size()),!i)return e||n.$parent;e=t,t=t.$parent}return n.$parent},findControllerAs=function(n,t){for(var e=n;e;){var i=t(e);if(i)return e;e=e.$parent}};!function(n,t){"function"==typeof define&&define.amd?define(t):"object"==typeof exports?module.exports=t():n.ListCacher=t()}(this,function(n){function t(n){var t={},e={},i={},o=function(t,e,i){var o=[];if(i)for(var r in t)for(var s in e)o.push(n([t[r],e[s]]).flatten().toArray());else for(var r in t)for(var s in e)o.push([t[r],e[s]]);return o},r=function(n){for(var t=!1,e=n[0],i=1;i<n.length;++i)e=o(e,n[i],t),t=!0;return e},s=function(t){var e=r(n(t).values().toArray()),i=n(t).keys().toArray();return e.map(function(n){var t={};return i.forEach(function(e,i){t[e]=n[i]}),t})},a=function(n,t){t||(t=" && ");var e=[];for(var i in n){var o=n[i];Array.isArray(o)?e.push(o.map(function(n){return"(x."+i+" === "+n+")"}).join(" || ")):e.push("(x."+i+" === "+o+")")}return new Function("x","return "+e.join(t))},c=function(t,e,i){var o=this.getIndexFor,r=(n(e).map(function(n,e){return[e,t+"."+e]}).toObject(),n(e).keys().map(function(n){return[n,o(t,n)]}).toObject());for(var s in e){var a=n(e[s]).difference(r[s]).toArray();if(a.length){var c=n([[s,a]]).toObject();return i||Array.prototype.push.apply(r[s],a),this.conditionalClean(c),console.log("single filter : "+JSON.stringify(e)+"\nOut :"+JSON.stringify(c)),c}return console.log("single filter : "+JSON.stringify(e)+"\nOut : null"),null}};this.conditionalClean=function(n,t){n.name in i||(i[n.name]=[]);i[n.name]},this.filter=function(o,r){console.log("------------------\nfilter : "+JSON.stringify(r));var u=o.modelName,l=n(r).size();switch(l){case 0:var f=t[u];return t[u]=!0,u in e&&delete e[u],console.log("out : null (got all)"),u in i&&delete i[u],f?null:{};case 1:return c.call(this,u,r)}var d=this,h=n(r).keys().some(function(n){var t={};return t[n]=r[n],null==c.call(d,u,t,!0)});if(h)return null;u in i||(i[u]=[]);var p=s(r),y=i[u].filter(a(r," || "));if(y.length){var m=[];for(var v in y)m.push.apply(m,p.filter(a(y[v])));console.log("exploded - partial : "+JSON.stringify(m));var g=n(p).difference(m).toArray()}else var g=p;if(g.length){i[u].push.apply(i[u],g);var g=n(r).keys().map(function(t){var e=n(g).pluck(t).unique().toArray();return[t,e.length?e:r[t]]}).toObject();return console.log("out : "+JSON.stringify(g)),g}return null},this.getIndexFor=function(n,t){var i=n+"."+t;return i in e||(e[i]=[]),e[i]}}return t});var baseORM=function(n,t){function e(n,t,e){this.klass=t,this.permissions=[],this.id=n;for(var i in e)this.push.apply(this,[i,e[i]])}if(n.constructor===String)var i=new reWheelConnection(n);else if(n.constructor===reWheelConnection)var i=n;this.connection=i,i.on("connected",function(){this.connected=!0});var o=i.events;this.on=o.on.bind(this),this.emit=o.emit.bind(this),this.$post=i.$post.bind(i),o.on("ws-connected",function(n){console.info("Websocket connected"),n.onMessageJson(r.gotData.bind(r)),n.onMessageText(function(n){console.info("WS message : "+n)})}),o.on("ws-disconnected",function(n){console.error("Websocket disconnected")}),o.on("error-json-404",function(n,t,e,i){console.error("JSON error ",JSON.stringify(n)),delete d[t.split("/")[0]]});var r=this,s={auth_group:Lazy({})};window.DB=s;var a={},c={},u={},l={},f={},d={},h=new ListCacher(Lazy),p=new AutoLinker(o,d,s,this,h);window.ll=p,window.lc=h,this.validationEvent=o.on("error-json-513",function(n,t,e,i){currentContext.savingErrorHanlder&&currentContext.savingErrorHanlder(new ValidationError(n))});var y=function(n){return n in s?s[n]:(s[n]=Lazy({}),s[n])},m=function(n){return n in UNLINKED?UNLINKED[n]:(UNLINKED[n]={},UNLINKED[n])};e.prototype.save=function(n){var t={permissions:Lazy(this.permissions).map(function(n){return[n[0].id,n[1]]}).toObject()};t.id=this.id;this.klass.modelName;W2P_POST(this.klass.modelName,"set_permissions",t,function(t,e,i,o){n(t)})},e.prototype.push=function(n,t){var e=Lazy(t),i=Lazy(this.klass.allPermissions).map(function(n){return[n,e.contains(n)]}).toObject(),o=Lazy(this.permissions).map(function(n){return n[0].id});o.contains(n)?this.permissions[o.indexOf(n)][1]=i:this.permissions.push([s.auth_group.get(n),i])};var v=function(n){var i=Lazy(n.fields);n.privateArgs&&(i=i.merge(n.privateArgs)),r.emit("model-definition",n);var f="if (!row) { row = {}};\n";f+=n.references.map(function(n){return"this._"+n.id+" = row."+n.id+";"}).join(";\n"),f+=i.map(function(n,t){return"date"==n.type||"datetime"==n.type?"this."+t+" = row."+t+"?new Date(row."+t+" * 1000 - tzOffset):null;\n":"boolean"==n.type?"this."+t+" = (row."+t+' === "T") || (row.'+t+" === true);\n":"this."+t+" = row."+t+";\n"}).toString("\n"),f+="if (permissions) {this._permissions = permissions && Lazy(permissions).map(function (x) { return [x, true] }).toObject();}";var d=new Function("row","permissions",f);d.prototype.orm=t,d.ref_translations={},d.modelName=n.name,d.references=Lazy(n.references).pluck("id").toArray(),d.inverse_references=n.referencedBy.map(function(n){return n.by+"_"+n.id+"_set"}),d.referents=n.referencedBy.map(function(n){return[n.by,n.id]}),d.fieldsOrder=n.fieldOrder,d.allPermissions=n.permissions,Lazy(n.representation).size()&&(d.prototype.toString=new Function("return this."+Lazy(n.representation).toString(' + " " + this.'))),d.prototype.toUpperCase=function(){return this.toString().toUpperCase()},d.prototype.toLowerCase=function(){return this.toString().toLowerCase()},d.prototype.delete=function(){return t.delete(this.constructor.modelName,[this.id])},d.prototype.all_perms=function(n){var t=this.id;rewheel.$post(this.constructor.modelName,"all_perms",{id:this.id},function(i){var o=i,r={},a=Lazy(o).pluck("group_id").unique().map(function(n){return""+n}).difference(s.auth_group.keys()).toArray();Lazy(o).groupBy(function(n){return n.group_id}).each(function(n,t){r[t]=Lazy(n).pluck("name").toArray()});var c=function(i){n(new e(t,d,r))};a.length?rewheel.$get("auth_group",a,void 0,c):c()})},d.prototype.save=function(n){if(n)for(var t in n)this[t]=n[t];var e={},i=this.asRaw();this.field;Lazy(this.constructor.fields).each(function(n){var t=d.privateArgs||{};"M2M"==n.type||!n.writable||n.id in t||(e[n.id]=i[n.id])});var o=r.$post(this.constructor.modelName+(this.id?"/post":"/put"),e);n&&n.constructor===Function&&(o.context.savingErrorHanlder=n)},d.prototype.copy=function(){var n=new this.constructor(this.asRaw());return n.permissions=this.permissions,n};var h="return {\n"+Lazy(n.references).map(function(n){return n.id+" : this._"+n.id}).concat(i.map(function(n,t){return"date"==n.type||"datetime"==n.type?t+" : (this."+t+"?(Math.round(this."+t+".getTime() - this."+t+".getTimezoneOffset() * 60000) / 1000):null)":"boolean"==n.type?t+" : this."+t+'?"T":"F"':t+" : this."+t})).toString(",\n")+"};";d.prototype.asRaw=new Function(h),d.saveMulti=function(n,t,e){var i=[],o=Lazy(d.fields).filter(function(n){return!n.writable}).pluck("id").toArray();Lazy(n).map(function(n){return n.asRaw()}).each(function(n){Lazy(o).each(function(t){delete n[t]}),i.push(n)}),r.$post(d.modelName,"put",{multiple:i,formIdx:r.formIdx++},function(n){r.gotData(n);var e=s[d.modelName],i=Lazy(n[d.modelName].results).pluck("id").map(function(n){return e.get(n)}).toArray();t&&t(i)},e)},"extra_verbs"in n&&Lazy(n.extra_verbs).each(function(n){var t=n[0],e=n[1],i="data = {id : this.id";e.length&&(i+=", "+Lazy(e).map(function(n){return n+" : "+n}).join(",")),i+="};",e.push("cb"),d.prototype[t]=new Function(e,i+'W2S.W2P_POST(this.constructor.modelName,"'+t+'", data,function(data,status,headers,x){try{\n   if (!headers("nomodel")) {window.W2S.gotData(data,cb);}\n   else {if (cb) {cb(data)}}\n} catch(e){\nif (cb) {cb(data);}\n}\n});\n')}),"privateArgs"in n&&(d.privateArgs=Lazy(n.privateArgs).keys().map(function(n){return[n,!0]}).toObject(),d.prototype.savePA=function(n){var t=this,e={id:this.id},i=this.constructor.privateArgs,o=this.constructor.fields,s=(new this.constructor(n).asRaw(),Lazy(i).keys().map(function(n){return[n,o[n]]}).toObject());Lazy(n).each(function(n,t){t in i&&s[t].writable&&(e[t]=n)}),r.$post(this.constructor.modelName+"/savePA",e,function(){Lazy(e).each(function(n,e){t[e]=n})})}),l[d.modelName]=d;for(var m in n.fields)n.fields[m].id=m;if(d.fields=Lazy(n.fields).concat(Lazy(n.privateArgs)).concat(Lazy(n.references).tap(function(n){n.type=n.type||"reference"})).indexBy("id").toObject(),Lazy(n.references).each(function(n){var e=n.to,i="_"+n.id;cachedPropertyByEvents(d.prototype,n.id,function(){if(!(e in s)){var n=this;r.describe(e,function(t){p.mainIndex[e].ask(n[i],!0)})}var t=e in s&&this[i]&&s[e].get(this[i]);return!t&&e in p.mainIndex?p.mainIndex[e].ask(this[i],!0):t},function(t){if(t&&t.constructor.modelName!=e)throw new TypeError("You can assign only "+e+" to "+n.id);this[i]=t.id},"new-"+e,"deleted-"+e,"updated-"+e,"new-model-"+e),d.prototype["get"+utils.capitalize(n.id)]=function(){return t.get(e,this[i])}}),Lazy(n.referencedBy).each(function(n){var e=n.by+"."+n.id,i=n.by+"_"+utils.pluralize(n.id),o=n.by;d.prototype.hasOwnProperty(i)?$log.error("Tryed to redefine property "+i+"s for "+d.modelName):cachedPropertyByEvents(d.prototype,i,function(){var n=o in s?a[e].get(this.id+""):null;return p.foreignKeys[e].ask(this.id,!0),n},null,"new-"+o,"updated-"+o,"deleted-"+o),d.prototype["get"+utils.capitalize(utils.pluralize(n.by))]=function(){var e={};return e[n.id]=[this.id],t.query(n.by,e)}}),n.manyToMany&&(Lazy(n.manyToMany).each(function(n){var t=n.indexName,e=n.first?0:1,i=n.model,o=p.m2mIndex[t]["get"+utils.capitalize(i)];cachedPropertyByEvents(d.prototype,n.model+"s",function(){var n=this,a=[],c=null,u=null;return p.getM2M(t,[n.id],e,function(t){c=o(n.id),c.length&&(r.fetch(i,{id:c}),u=y(i).get.bind(s[i]))}),c&&u&&(a=Lazy(c).map(u).filter(utils.bool).toArray()),a},null,"received-m2m-"+t),d.prototype["get"+utils.capitalize(utils.pluralize(i))]=function(){var n=this;return new Promise(function(a,c){try{p.getM2M(t,[n.id],e,function(t){var e=o(n.id);e.length?r.fetch(i,{id:e},null,function(){var n=s[i].get.bind(s[i]);a(Lazy(e).map(n).filter(utils.bool).toArray())}):a([])})}catch(n){console.error(n),c(n)}})},d.fields[utils.capitalize(i)]={id:utils.capitalize(i),name:utils.capitalize(i),writable:!0,readable:!0,type:"M2M",validators:[]}}),d.prototype.unlinkReference=function(n){var t=!1,e=this.id,i=[];"Array"==n.constructor.name&&(t=!0,i=n,n=i[0]);var o=n.constructor.modelName;if(t)var s=Lazy(i).pluck("id").map(function(n){return[e,n]}).toArray();else var s=[[e,n.id]];r.$post(d.modelName+"/"+o+"s/delete",{collection:s})},d.prototype.linkReference=function(n){var t=!1,e=this.id,i=[];"Array"==n.constructor.name&&(t=!0,i=n,n=i[0]);var o=n.constructor.modelName,s=d.modelName+"/"+o;if(t){var a=[];if(s in INDEX_M2M&&(a=Lazy(i).pluck("id").difference(Lazy(INDEX_M2M[s][0].get(this.id))).toArray()),s=o+"/"+d.modelName,s in INDEX_M2M&&(a=Lazy(i).pluck("id").difference(Lazy(INDEX_M2M[s][0].get(this.id))).toArray()),a.length){var c=Lazy(a).map(function(n){return[e,n]}).toArray();W2P_POST(d.modelName,o+"s/put",{collection:c},function(n){})}}else{if(s in p.m2mIndex&&Lazy(p.m2mIndex[s]["get"+utils.capitalize(o)](n.id)).find(this))return;r.$post(d.modelName+"/"+o+"s/put",{collection:[[this.id,n.id]]})}}),d.modelName in c)for(;c[d.modelName].length;){var v=c[d.modelName].pop();Lazy(u[d.modelName]).map(function(n){return n.toString()}).contains(v.toString())||(v(d),u[d.modelName].push(v))}return o.emit("new-model",d),o.emit("new-model-"+d.modelName),d};this.gotData=function(n,t){if(console.info("gotData"),"string"!=typeof n){"_extra"in n&&delete n._extra;var e=n.TOONE,i=n.TOMANY,c=n.MANYTOMANY,u=n.PERMISSIONS,f=n.PA;if(delete n.TOONE,delete n.TOMANY,delete n.MANYTOMANY,delete n.PERMISSIONS,delete n.PA,f||(f={}),n=Lazy(n).filter(function(n,t){return!("deleted"in n)||t in r.modelCache}).toObject(),"m2m"in n){var d=n.m2m;delete n.m2m}Lazy(n).each(function(n,t){r.describe(t,function(e){var i=e;n.results&&n.results.length>0&&n.results[0].constructor==Array&&(n.results=Lazy(n.results).map(function(n){return Lazy(i.fieldsOrder).zip(n).toObject()}).toArray());var r=Lazy(n.results),c=n.deleted;if(t in f){var u=f[t];Lazy(r).each(function(n){n.id in u&&Lazy(u[n.id]).each(function(t,e){n[e]=t})})}var d=y(t),h=d.source;c&&c.forEach(function(n){delete h[n]});var p=r.indexBy("id"),m=p.keys(),v=m.difference(d.keys().map(function(n){return parseInt(n)})),g=m.difference(v);g=g.filter(function(n){return!utils.sameAs(p.get(n),d.get(n).asRaw())});var z=n.permissions?Lazy(n.permissions):Lazy({}),L=v.map(function(n){return new i(p.get(n),z.get(n))}),w=[];g.each(function(n){var t=d.get(n),o=t.copy(),r=new i(p.get(n));Lazy(e.fields).keys().each(function(n){t[n]=r[n]}),w.push([t,o])}),w.length&&o.emit("updated-"+t,w);var N=L.toArray();Lazy(N).each(function(n){h[n.id]=n}),Lazy(l[t].references).each(function(n){a[t+"."+n]=s[t].groupBy("_"+n)}),N.length&&o.emit("new-"+t,Lazy(N),n.totalResults),c&&o.emit("deleted-"+t,c),o.emit("received-"+t)})}),e&&(console.error("TOONE"),Lazy(e).each(function(n,t){console.log(t);m(t)})),i&&(console.error("TOMANY"),Lazy(i).each(function(n,t){t in ASKED_UNLINKED||(ASKED_UNLINKED[t]=Lazy([])),Lazy(n).each(function(n){ASKED_UNLINKED[t].source.push(n)})})),c&&(console.error("MANYTOMANY"),Lazy(c).each(function(n,t){var e=parseInt(t.split("|")[1]);t=t.split("|")[0],t in ASKED_M2M||(ASKED_M2M[t]=[{},{}]);var i=ASKED_M2M[t][e];Lazy(n).each(function(n){i[n+""]=!0,i[n]=!0})})),d&&r.gotM2M(d),u&&r.gotPermissions(u),t&&t(n),o.emit("got-data")}else if(console.log("data "+n+" refused from gotData()"),t)return t(n)},this.gotM2M=function(n){Lazy(n).each(function(n,t){var e=p.m2mIndex[t];Lazy(n).each(function(n){Lazy(n).each(function(n,t){e[t](n)})}),o.emit("received-m2m"),o.emit("received-m2m-"+t)})},this.fetch=function(n,t,e,i){n in d?setTimeout(function(){r.fetch(n,t,e,i)},500):r.describe(n,function(e){return r.connection.options.realtimeEndPoint?(t=h.filter(e,t),t?(d[n]=!0,r.$post(n+"/list",{filter:t},function(t){r.gotData(t,i),delete d[n]},function(){delete d[n]})):i&&i(),t):void this.$post(n+"/list",sendData,function(e){t||GOT_ALL.source.push(n),r.gotData(e,i)})})},this.get=function(n,t,e){t.constructor!==Array&&(t=[t]),r.fetch(n,{id:t},null,function(){var i=[],o=s[n];for(var r in t)i.push(o.source[t[r]]);e(i)})},this.gotModel=function(n){for(var t in n){var e=n[t];localStorage["description:"+t]=JSON.stringify(n),l[t]=v(e),t in s||(s[t]=Lazy({}))}},this.describe=function(n,t){var e=l[n];if(e)t&&t(e);else if(n in d)setTimeout(function(){r.describe(n,t)},500);else{if(n in f)return;var i="description:"+n;i in localStorage?(this.gotModel(JSON.parse(localStorage[i])),t&&t(l[n])):(d[n]=!0,this.$post(n+"/describe",null,function(e){r.gotModel(e),t&&t(l[n]),delete d[n]},function(t){this.events.modelNotFound.handle(n),f[n]=!0}))}},this.addBuilderHandler=function(n,t){var e=utils.hash(t);n in c||(c[n]=new Handler),n in u||(u[n]={}),c.addHandler(t),n in l&&(Lazy(u[n]).map(function(n){return n.toString()}).contains(t.toString())||(t.apply(this,[r.modelCache[n]]),u[n].push(e)))},this.connect=function(n){this.isConnected?n(this.connection.options):this.connection.connect(function(t){r.isConnected=!0,n(t)})},this.query=function(n,t,e,i){var o=this;this.describe(n,function(r){var s=utils.makeFilter(r,t),a=y(n);o.fetch(n,t,e,function(n){i(a.filter(s).values().toArray())})})},this.delete=function(n,t,e){return this.$post(n+"/delete",{id:t},e)}};reWheelORM.prototype.get=function(n,t){var e=this,i=!1,o=n;return t.constructor!==Array&&(i=!0,t=[t]),new Promise(function(n,r){try{e.$orm.connect(function(){i?e.$orm.get(o,t,function(t){n(t[0])}):e.$orm.get(o,t,n)})}catch(n){r(n)}})},reWheelORM.prototype.query=function(n,t,e){var i=this;return new Promise(function(o,r){var s=null;e&&e.constructor===Array&&e.length?s=e:e&&e.constructor===String&&e.length&&(s=e.split(","));try{i.$orm.isConnected?i.$orm.query(n,t,s,o):i.$orm.connect(function(){i.$orm.query(n,t,s,o)})}catch(n){r(n)}})},reWheelORM.prototype.delete=function(n,t){var e=this;return new Promise(function(i,o){try{e.$orm.connected?e.$orm.delete(n,t,i):e.$orm.connect(function(){e.$orm.delete(n,t,i)})}catch(n){o(n)}})};