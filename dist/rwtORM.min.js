(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);throw new Error("Cannot find module '"+o+"'")}var f=n[o]={exports:{}};t[o][0].call(f.exports,function(e){var n=t[o][1][e];return s(n?n:e)},f,f.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){
"use strict";function Handler(){this.handlers=[],this.strHandlers={}}function NamedEventManager(){var n={},r={},t=0;this.on=function(a,e){a in n||(n[a]=new Array);var i=t++;return n[a].push(e),r[i]=e,i},this.emit=function(r){if(r in n){var t=Array.prototype.slice.call(arguments,1);n[r].forEach(function(n){n.apply(null,t)})}},this.unbind=function(t){var a=0;if(t in r){var e=r[t+""];Lazy(n).each(function(n,r){var t=[];for(var i in n)n[i]===e&&(t.push(i),a++);t.reverse().forEach(function(r){n.splice(r,1)})})}return delete r[t],a}}Handler.prototype.addHandler=function(n){var r=utils.hash(n.toString());r in this.strHandlers||(this.strHandlers[r]=n,this.handlers.push(n))},Handler.prototype.handle=function(){var n=Array.prototype.slice.call(arguments,0);this.handlers.forEach(function(r){r.apply(null,n)})},Handler.prototype.handleBy=function(){var n=Array.prototype.slice.call(arguments,1),r=arguments[0];this.handlers.forEach(function(t){t.apply(r,n)})};
},{}]},{},[1])
(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);throw new Error("Cannot find module '"+o+"'")}var f=n[o]={exports:{}};t[o][0].call(f.exports,function(e){var n=t[o][1][e];return s(n?n:e)},f,f.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){
"use strict";function reWheelConnection(n,t){this.getLogin=t,this.events=new NamedEventManager,this.$POST=$POST.bind(this),this.options={endPoint:n},this.on=this.events.on.bind(this)}var cachedKeyIdx=0,cached=function(n,t){function e(){return this[t]||(this[t]=n.call(this,[arguments])),this[t]}return t||(t="_"+cachedKeyIdx++),e},$POST=function(n,t,e,o,i){var s={accepts:"application/json",url:n,data:JSON.stringify(t),dataType:"json",success:e,error:o,method:"POST",contentType:"application/json"};return i&&(s.headers=i,s.crossDomain=!0),$.ajax(s)};reWheelConnection.prototype.status=function(n){if(this._status_calling){var t=this;return setTimeout(function(){t.status(n)},50)}if(!this.options||!this.options.timestamp){this._status_calling=!0;var t=this;return this.$post("api/status",null,function(e){t._status_calling=!1;for(var o in e)t.options[o]=e[o];if(!e.user_id&&t.getLogin){var i=t.getLogin();i.constructor===Object&&t.login(i.username,i.password).then(function(e){for(var o in e)t.options[o]=e[o];n&&n(e)})}else n&&n(t.options)})}n&&n(this.options)},reWheelConnection.prototype.$post=function(n,t,e){var o=this;if(this.options&&this.options.token&&(t||(t={})),this.options.token)var i={token:this.options.token,application:this.options.application};else var i=null;var s=$POST(this.options.endPoint+n,t,function(i,s,r){o.events.emit("http-response",i,r.status,n,t),o.events.emit("http-response-"+r.status,i,n,t),e&&e(i)},function(e){try{var i=JSON.parse(e.responseText);o.events.emit("error-json",i,e.status,n,t,e),o.events.emit("error-json-"+e.status,i,n,t,e)}catch(i){o.events.emit("error-http",e.responseText,e.status,n,t,e),o.events.emit("error-http-"+e.status,e.responseText,n,t,e)}},i);return s},reWheelConnection.prototype.login=function(n,t){var e=this.options.endPoint+"api/login",o=this,i=null;return this.options.token&&(i={token:this.options.token}),new Promise(function(i,s){$.ajax({url:e,data:{username:n,password:t},dataType:"json",method:"POST",mimeType:"application/json",crossDomain:!0,success:function(n){for(var t in n)o.options[t]=n[t];i(n)},error:function(n,t,e){s(n.responseJSON)}})})},reWheelConnection.prototype.connect=function(n){var t=this;return this.status(function(e){"token"in t.options?n&&n(e):(console.log("connecting to "+this.options.endPoint),t.options.username&&t.options.password&&t.login(t.options.username,t.options.password,function(t){n&&n(t),console.log("renewing connection")})),e.token&&e.realtimeEndPoint&&!t.wsConnection&&(t.wsConnection=new utils.wsConnect(e),t.wsConnection.onConnect(function(){t.events.emit("ws-connected",t.wsConnection)}),t.wsConnection.onDisconnect(function(){t.events.emit("ws-disconnected",t.wsConnection),t.wsConnection=new utils.wsConnect(e)}))})};var utils={renameFunction:function(n,t){return new Function("return function (call) { return function "+n+" () { return call(this, arguments) }; };")()(Function.apply.bind(t))},log:function(){console.log(arguments)},setToParent:function(n,t,e){if(t in n){for(var o=n,i=o;o&&t in o;)i=o,o=o.$parent;t in i&&(i[t]=e)}},capitalize:function(n){return n[0].toUpperCase()+n.slice(1).toLowerCase()},hash:function(n){n=n.toString();for(var t=1,e=0;e<n.length;e++)t*=1+n.charCodeAt(e);return(t%34958374957).toString()},makeListCacheKey:function(n,t){return JSON.stringify(Lazy(n).map(function(n,t){return[t,Lazy(n).map(function(n){return n+""}).sort().toArray()]}).toObject())},makeFilter:function(n,t){var e=Lazy(t).map(function(t,e){if(t.constructor==Array)t=Lazy(t).map(function(n){return[n,1]}).toObject();else if(isFinite(t)||"Number"==typeof t){var o={};o[t]=1,t=o}return Lazy(n.references).contains(e)&&(e="_"+e),[e,t]}).toObject();return function(n){return Lazy(e).all(function(t,e){return n[e]in t})}},sameAs:function(n,t){for(var e in n)if(t[e]!=n[e])return!1;return!0},wsConnect:function(n){var t=this;this.handlers={wizard:new Handler,onConnection:new Handler,onDisconnection:new Handler,onMessageJson:new Handler,onMessageText:new Handler},this.onWizard=this.handlers.wizard.addHandler.bind(this.handlers.wizard),this.onConnect=this.handlers.onConnection.addHandler.bind(this.handlers.onConnection),this.onDisconnect=this.handlers.onDisconnection.addHandler.bind(this.handlers.onDisconnection),this.onMessageJson=this.handlers.onMessageJson.addHandler.bind(this.handlers.onMessageJson),this.onMessageText=this.handlers.onMessageText.addHandler.bind(this.handlers.onMessageText),this.options=n;var e=new SockJS(n.realtimeEndPoint);e.onopen=function(n){console.log("open : "+n),e.tenant(),t.handlers.onConnection.handle(n)},e.onmessage=function(n){if("message"==n.type)try{t.handlers.onMessageJson.handle($.parseJSON(n.data))}catch(e){t.handlers.onMessageText.handle(n.data)}else console.log(n)},e.onclose=function(){setTimeout(utils.wsConnect,1e3),t.handlers.onDisconnection.handle()},e.tenant=function(){e.send("TENANT:"+t.options.application)}},pluralize:function(n,t){return n+"s"},beforeCall:function(n,t){var e=function(){t().then(n)};return e},cleanStorage:function(){Lazy(localStorage).keys().each(function(n){delete localStorage[n]})},reverse:function(n,t){return t.split(n).reverse().join(n)},bool:Boolean,noop:function(){}},tzOffset=6e4*(new Date).getTimezoneOffset(),findControllerScope=function(n){for(var t=n,e=void 0,o=!0,i=Lazy(Lazy(n).find(function(n,t){return n&&n.constructor.$inject}).constructor.$inject);t;){o=!1;var s=Lazy(t).find(function(n,t){return n&&n.constructor.$inject});if(s&&(o=0==i.difference(s.constructor.$inject).size()),!o)return e||n.$parent;e=t,t=t.$parent}return n.$parent},findControllerAs=function(n,t){for(var e=n;e;){var o=t(e);if(o)return e;e=e.$parent}};
},{}]},{},[1])
(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);throw new Error("Cannot find module '"+o+"'")}var f=n[o]={exports:{}};t[o][0].call(f.exports,function(e){var n=t[o][1][e];return s(n?n:e)},f,f.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){
"use strict";function Toucher(){var n=!1;this.touch=function(){n=!0},this.touched=function(){var e=n;return n=!1,e}}function VacuumCacher(n,e,t){if(!e)var e=[];var i=[];this.ask=function(t,a){Lazy(e).contains(t)||(i.push(t),a||e.push(t),n.touch())},this.getAskedIndex=function(){return e},this.missings=function(){return Lazy(i.splice(0,i.length)).unique().toArray()}}function ManyToManyRelation(n,e){var t=[];this.add=t.push.bind(t),this.add=function(n){console.log("adding "+n),Lazy(t).find(n)||t.push(n)},this["get"+utils.capitalize(n.indexName.split("/")[0])]=function(n){return e[1].ask(n),Lazy(t).filter(function(e){return e[0]===n}).pluck("1").toArray()},this["get"+utils.capitalize(n.indexName.split("/")[1])]=function(n){return e[0].ask(n),Lazy(t).filter(function(e){return e[1]===n}).pluck("0").toArray()},this.del=function(n){for(var e=t.length,i=null,a=0;a<e;a++)if(t[a][0]===n[0]&&t[a][1]===n[1]){i=a;break}i&&t.splice(a,1),console.log("deleting ",n)}}function AutoLinker(n,e,t,i,a){var r=new Toucher,u={},o={},c={},s={},f={};this.mainIndex=u,this.foreignKeys=o,this.m2m=c,this.m2mIndex=s,this.permissions=f,n.on("model-definition",function(n){var e=a.getIndexFor(n.name,"id");u[n.name]=new VacuumCacher(r,e,"mainIndex."+n.name),f[n.name]=new VacuumCacher(r,null,"permissions."+n.name),Lazy(n.references).each(function(e){var t=n.name+"_"+e.id;o[t]=new VacuumCacher(r,a.getIndexFor(e.to,"id"),e.to+".id foreignKeys."+t)}),Lazy(n.referencedBy).each(function(n){var e=n.by+"."+n.id;o[e]=new VacuumCacher(r,a.getIndexFor(n.by,n.id),n.by+"."+n.id+" foreignKeys."+e)}),Lazy(n.manyToMany).each(function(n){n.indexName in c||(c[n.indexName]=[new VacuumCacher(r,null,"m2m."+n.indexName+"[0]"),new VacuumCacher(r,null,"m2m."+n.indexName+"[1]")]),n.indexName in s||(s[n.indexName]=new ManyToManyRelation(n,c[n.indexName]))})});var h=function(n,t,a,r){Lazy(t).each(c[n][a].ask.bind(c[n][a])),t=c[n][a].missings(),t.length?(e[n]=1,i.$post((a?utils.reverse("/",n):n)+"s/list",{collection:t},function(t){i.gotData(t,r),delete e[n]})):r&&r()};this.getM2M=h;var l=function(){if(r.touched()){if(Lazy(e).values().sum())return void r.touch();var n=!1;Lazy(c).each(function(e,t){Lazy(e).each(function(e,i){var a=e.missings();if(a=Lazy(a).filter(function(n){return n}).map(function(n){return parseInt(n)}).toArray(),a.length){s[t];n=!0,h(t,a,i)}})}),Lazy(u).each(function(e,a){var r=e.missings();if(r.length){n=!0;a in t?t[a].keys():Lazy();i.fetch(a,{id:r},null,utils.noop)}}),Lazy(o).map(function(n,e){return[e,n.missings()]}).filter(function(n){return n[1].length}).each(function(e){n=!0;var t=e[1],a=e[0],r=a.split("."),u=r[0],o=r[1],c={};c[o]=t,i.fetch(u,c)})}};setInterval(l,50)}function cachedPropertyByEvents(n,e,t,i){var a=Array.prototype.slice.call(arguments,4),r={};Lazy(a).each(function(e){n.orm.on(e,function(){r={}})});var u={get:function(){return this.id in r||(r[this.id]=t.call(this)),r[this.id]}};i&&(u.set=function(n){n!==r[this.id]&&(i.call(this,n),this.id in r&&delete r[this.id])}),Object.defineProperty(n,e,u)}var ListCacher=function(){var n={},e={};this.filter=function(t,i){var a=this.getIndexFor,r=t.modelName;if(r in n)return null;if(0==Lazy(i).size())return n[r]=!0,r in e&&delete e[r],{};var u=Lazy(i).map(function(n,e){return[e,r+"."+e]}).toObject(),o=Lazy(i).keys().map(function(n){return[n,a(r,n)]}).toObject(),c=Lazy(i).map(function(n,t){return[t,Lazy(n).difference(e[u[t]]).unique().toArray()]}).filter(function(n){return n[1].length}).toObject();return Lazy(c).size()?(Lazy(i).each(function(n,t){var i=Lazy(n).difference(o[t]).toArray();i.length&&Array.prototype.push.apply(e[r+"."+t],n)}),c):null},this.getIndexFor=function(n,t){var i=n+"."+t;return i in e||(e[i]=[]),e[i]}};
},{}]},{},[1])
(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);throw new Error("Cannot find module '"+o+"'")}var f=n[o]={exports:{}};t[o][0].call(f.exports,function(e){var n=t[o][1][e];return s(n?n:e)},f,f.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){
"use strict";function ValidationError(e){this.resource=e._resource,this.formIdx=e.formIdx,this.fields=e.errors}function reWheelORM(e){this.$orm=new baseORM(e,this),this.on=this.$orm.on.bind(this.$orm)}var baseORM=function(e,t){function n(e,t,n){this.klass=t,this.permissions=[],this.id=e;for(var i in n)this.push.apply(this,[i,n[i]])}if(e.constructor===String)var i=new reWheelConnection(e);else if(e.constructor===reWheelConnection)var i=e;this.connection=i,i.on("connected",function(){this.connected=!0});var r=i.events;this.on=r.on.bind(this),this.emit=r.emit.bind(this),this.$post=i.$post.bind(i),r.on("ws-connected",function(e){console.info("Websocket connected"),e.onMessageJson(o.gotData.bind(o)),e.onMessageText(function(e){console.info("WS message : "+e)})}),r.on("ws-disconnected",function(e){console.error("Websocket disconnected")}),r.on("error-json-404",function(e,t,n,i){console.error("JSON error ",JSON.stringify(e)),delete h[t.split("/")[0]]});var o=this,a={auth_group:Lazy({})};window.DB=a;var s={},c={},u=Lazy([]),l={},d={},f={},p={},h={},m=new ListCacher,y=new AutoLinker(r,h,a,this,m);window.ll=y,window.lc=m,this.validationEvent=r.on("error-json-513",function(e,t,n,i){currentContext.savingErrorHanlder&&currentContext.savingErrorHanlder(new ValidationError(e))});var v=function(e){return e in a?a[e]:(a[e]=Lazy({}),a[e])},g=function(e){return e in UNLINKED?UNLINKED[e]:(UNLINKED[e]={},UNLINKED[e])};n.prototype.save=function(e){var t={permissions:Lazy(this.permissions).map(function(e){return[e[0].id,e[1]]}).toObject()};t.id=this.id;this.klass.modelName;W2P_POST(this.klass.modelName,"set_permissions",t,function(t,n,i,r){e(t)})},n.prototype.push=function(e,t){var n=Lazy(t),i=Lazy(this.klass.allPermissions).map(function(e){return[e,n.contains(e)]}).toObject(),r=Lazy(this.permissions).map(function(e){return e[0].id});r.contains(e)?this.permissions[r.indexOf(e)][1]=i:this.permissions.push([a.auth_group.get(e),i])};var z=function(e){var i=Lazy(e.fields);e.privateArgs&&(i=i.merge(e.privateArgs)),o.emit("model-definition",e);var u="if (!row) { row = {}};\n";u+=e.references.map(function(e){return"this._"+e.id+" = row."+e.id+";"}).join(";\n"),u+=i.map(function(e,t){return"date"==e.type||"datetime"==e.type?"this."+t+" = row."+t+"?new Date(row."+t+" * 1000 - tzOffset):null;\n":"boolean"==e.type?"this."+t+" = (row."+t+' === "T") || (row.'+t+" === true);\n":"this."+t+" = row."+t+";\n"}).toString("\n"),u+="if (permissions) {this._permissions = permissions && Lazy(permissions).map(function (x) { return [x, true] }).toObject();}";var p=new Function("row","permissions",u);p.prototype.orm=t,p.ref_translations={},p.modelName=e.name,p.references=Lazy(e.references).pluck("id").toArray(),p.inverse_references=e.referencedBy.map(function(e){return e.by+"_"+e.id+"_set"}),p.referents=e.referencedBy.map(function(e){return[e.by,e.id]}),p.fieldsOrder=e.fieldOrder,p.allPermissions=e.permissions,Lazy(e.representation).size()&&(p.prototype.toString=new Function("return this."+Lazy(e.representation).toString(' + " " + this.'))),p.prototype.toUpperCase=function(){return this.toString().toUpperCase()},p.prototype.toLowerCase=function(){return this.toString().toLowerCase()},p.prototype.delete=function(){return t.delete(this.constructor.modelName,[this.id])},p.prototype.all_perms=function(e){var t=this.id;rewheel.$post(this.constructor.modelName,"all_perms",{id:this.id},function(i){var r=i,o={},s=Lazy(r).pluck("group_id").unique().map(function(e){return""+e}).difference(a.auth_group.keys()).toArray();Lazy(r).groupBy(function(e){return e.group_id}).each(function(e,t){o[t]=Lazy(e).pluck("name").toArray()});var c=function(i){e(new n(t,p,o))};s.length?rewheel.$get("auth_group",s,void 0,c):c()})},p.prototype.save=function(e){if(e)for(var t in e)this[t]=e[t];var n={},i=this.asRaw();this.field;Lazy(this.constructor.fields).each(function(e){var t=p.privateArgs||{};"M2M"==e.type||!e.writable||e.id in t||(n[e.id]=i[e.id])});var r=o.$post(this.constructor.modelName+(this.id?"/post":"/put"),n);e&&e.constructor===Function&&(r.context.savingErrorHanlder=e)},p.prototype.copy=function(){var e=new this.constructor(this.asRaw());return e.permissions=this.permissions,e};var h="return {\n"+Lazy(e.references).map(function(e){return e.id+" : this._"+e.id}).concat(i.map(function(e,t){return"date"==e.type||"datetime"==e.type?t+" : (this."+t+"?(Math.round(this."+t+".getTime() - this."+t+".getTimezoneOffset() * 60000) / 1000):null)":"boolean"==e.type?t+" : this."+t+'?"T":"F"':t+" : this."+t})).toString(",\n")+"};";p.prototype.asRaw=new Function(h),p.saveMulti=function(e,t,n){var i=[],r=Lazy(p.fields).filter(function(e){return!e.writable}).pluck("id").toArray();Lazy(e).map(function(e){return e.asRaw()}).each(function(e){Lazy(r).each(function(t){delete e[t]}),i.push(e)}),o.$post(p.modelName,"put",{multiple:i,formIdx:o.formIdx++},function(e){o.gotData(e);var n=a[p.modelName],i=Lazy(e[p.modelName].results).pluck("id").map(function(e){return n.get(e)}).toArray();t&&t(i)},n)},"extra_verbs"in e&&Lazy(e.extra_verbs).each(function(e){var t=e[0],n=e[1],i="data = {id : this.id";n.length&&(i+=", "+Lazy(n).map(function(e){return e+" : "+e}).join(",")),i+="};",n.push("cb"),p.prototype[t]=new Function(n,i+'W2S.W2P_POST(this.constructor.modelName,"'+t+'", data,function(data,status,headers,x){try{\n   if (!headers("nomodel")) {window.W2S.gotData(data,cb);}\n   else {if (cb) {cb(data)}}\n} catch(e){\nif (cb) {cb(data);}\n}\n});\n')}),"privateArgs"in e&&(p.privateArgs=Lazy(e.privateArgs).keys().map(function(e){return[e,!0]}).toObject(),p.prototype.savePA=function(e){var t=this,n={id:this.id},i=this.constructor.privateArgs,r=this.constructor.fields,a=(new this.constructor(e).asRaw(),Lazy(i).keys().map(function(e){return[e,r[e]]}).toObject());Lazy(e).each(function(e,t){t in i&&a[t].writable&&(n[t]=e)}),o.$post(this.constructor.modelName+"/savePA",n,function(){Lazy(n).each(function(e,n){t[n]=e})})}),f[p.modelName]=p;for(var m in e.fields)e.fields[m].id=m;if(p.fields=Lazy(e.fields).concat(Lazy(e.privateArgs)).concat(Lazy(e.references).tap(function(e){e.type=e.type||"reference"})).indexBy("id").toObject(),Lazy(e.references).each(function(e){var n=e.to,i="_"+e.id;cachedPropertyByEvents(p.prototype,e.id,function(){n in a||o.describe(n);var e=n in a&&this[i]&&a[n].get(this[i]);return e?e:y.mainIndex[n].ask(this[i],!0)},function(t){if(t&&t.constructor.modelName!=n)throw new TypeError("You can assign only "+n+" to "+e.id);this[i]=t.id},"new-"+n,"deleted-"+n),p.prototype["get"+utils.capitalize(e.id)]=function(){return t.get(n,this[i])}}),Lazy(e.referencedBy).each(function(e){var n=e.by+"."+e.id,i=e.by+"_"+utils.pluralize(e.id),r=e.by;p.prototype.hasOwnProperty(i)?$log.error("Tryed to redefine property "+i+"s for "+p.modelName):cachedPropertyByEvents(p.prototype,i,function(){var e=r in a?s[n].get(this.id+""):null;return y.foreignKeys[n].ask(this.id,!0),e},null,"new-"+r,"updated-"+r,"deleted-"+r),p.prototype["get"+utils.capitalize(utils.pluralize(e.by))]=function(){var n={};return n[e.id]=[this.id],t.query(e.by,n)}}),e.manyToMany&&(Lazy(e.manyToMany).each(function(e){var t=e.indexName,n=e.first?0:1,i=e.model,r=y.m2mIndex[t]["get"+utils.capitalize(i)];cachedPropertyByEvents(p.prototype,e.model+"s",function(){var e=this,s=[],c=null,u=null;return y.getM2M(t,[e.id],n,function(t){c=r(e.id),c.length&&(o.fetch(i,{id:c}),u=a[i].get.bind(a[i]))}),c&&u&&(s=Lazy(c).map(u).filter(utils.bool).toArray()),s},null,"received-m2m-"+t),p.prototype["get"+utils.capitalize(utils.pluralize(i))]=function(){var e=this;return new Promise(function(s,c){try{y.getM2M(t,[e.id],n,function(t){var n=r(e.id);n.length?o.fetch(i,{id:n},null,function(){var e=a[i].get.bind(a[i]);s(Lazy(n).map(e).filter(utils.bool).toArray())}):s([])})}catch(e){console.error(e),c(e)}})},p.fields[utils.capitalize(i)]={id:utils.capitalize(i),name:utils.capitalize(i),writable:!0,readable:!0,type:"M2M",validators:[]}}),p.prototype.unlinkReference=function(e){var t=!1,n=this.id,i=[];"Array"==e.constructor.name&&(t=!0,i=e,e=i[0]);var r=e.constructor.modelName;if(t)var a=Lazy(i).pluck("id").map(function(e){return[n,e]}).toArray();else var a=[[n,e.id]];o.$post(p.modelName+"/"+r+"s/delete",{collection:a})},p.prototype.linkReference=function(e){var t=!1,n=this.id,i=[];"Array"==e.constructor.name&&(t=!0,i=e,e=i[0]);var r=e.constructor.modelName,a=p.modelName+"/"+r;if(t){var s=[];if(a in c&&(s=Lazy(i).pluck("id").difference(Lazy(c[a][0].get(this.id))).toArray()),a=r+"/"+p.modelName,a in c&&(s=Lazy(i).pluck("id").difference(Lazy(c[a][0].get(this.id))).toArray()),s.length){var u=Lazy(s).map(function(e){return[n,e]}).toArray();W2P_POST(p.modelName,r+"s/put",{collection:u},function(e){})}}else{if(a in y.m2mIndex&&Lazy(y.m2mIndex[a]["get"+utils.capitalize(r)](e.id)).find(this))return;o.$post(p.modelName+"/"+r+"s/put",{collection:[[this.id,e.id]]})}}),p.modelName in l)for(;l[p.modelName].length;){var v=l[p.modelName].pop();Lazy(d[p.modelName]).map(function(e){return e.toString()}).contains(v.toString())||(v(p),d[p.modelName].push(v))}return r.emit("new-model",p),p};this.gotData=function(e,t){if(console.info("gotData"),"string"!=typeof e){"_extra"in e&&delete e._extra;var n=e.TOONE,i=e.TOMANY,c=e.MANYTOMANY,u=e.PERMISSIONS,l=e.PA;if(delete e.TOONE,delete e.TOMANY,delete e.MANYTOMANY,delete e.PERMISSIONS,delete e.PA,l||(l={}),e=Lazy(e).filter(function(e,t){return!("deleted"in e)||t in o.modelCache}).toObject(),"m2m"in e){var d=e.m2m;delete e.m2m}Lazy(e).each(function(e,t){o.describe(t,function(n){var i=n;e.results&&e.results.length>0&&e.results[0].constructor==Array&&(e.results=Lazy(e.results).map(function(e){return Lazy(i.fieldsOrder).zip(e).toObject()}).toArray());var o=Lazy(e.results),c=e.deleted;if(t in l){var u=l[t];Lazy(o).each(function(e){e.id in u&&Lazy(u[e.id]).each(function(t,n){e[n]=t})})}var d=v(t),p=d.source;c&&c.forEach(function(e){delete p[e]});var h=o.indexBy("id"),m=h.keys(),y=m.difference(d.keys().map(function(e){return parseInt(e)})),g=m.difference(y);g=g.filter(function(e){return!utils.sameAs(h.get(e),d.get(e).asRaw())});var z=e.permissions?Lazy(e.permissions):Lazy({}),L=y.map(function(e){return new i(h.get(e),z.get(e))}),w=[];g.each(function(e){var t=d.get(e),r=t.copy(),o=new i(h.get(e));Lazy(n.fields).keys().each(function(e){t[e]=o[e]}),w.push([t,r])}),w.length&&r.emit("updated-"+t,w);var N=L.toArray();Lazy(N).each(function(e){p[e.id]=e}),Lazy(f[t].references).each(function(e){s[t+"."+e]=a[t].groupBy("_"+e)}),N.length&&r.emit("new-"+t,Lazy(N),e.totalResults),c&&r.emit("deleted-"+t,c),r.emit("received-"+t)})}),n&&(console.error("TOONE"),Lazy(n).each(function(e,t){console.log(t);g(t)})),i&&(console.error("TOMANY"),Lazy(i).each(function(e,t){t in ASKED_UNLINKED||(ASKED_UNLINKED[t]=Lazy([])),Lazy(e).each(function(e){ASKED_UNLINKED[t].source.push(e)})})),c&&(console.error("MANYTOMANY"),Lazy(c).each(function(e,t){var n=parseInt(t.split("|")[1]);t=t.split("|")[0],t in ASKED_M2M||(ASKED_M2M[t]=[{},{}]);var i=ASKED_M2M[t][n];Lazy(e).each(function(e){i[e+""]=!0,i[e]=!0})})),d&&o.gotM2M(d),u&&o.gotPermissions(u),t&&t(e),r.emit("got-data")}else if(console.log("data "+e+" refused from gotData()"),t)return t(e)},this.gotM2M=function(e){Lazy(e).each(function(e,t){var n=y.m2mIndex[t];Lazy(e).each(function(e){Lazy(e).each(function(e,t){n[t](e)})}),r.emit("received-m2m"),r.emit("received-m2m-"+t)})},this.fetch=function(e,t,n,i){e in h?setTimeout(function(){o.fetch(e,t,n,i)},500):o.describe(e,function(n){return o.connection.options.realtimeEndPoint?(t=m.filter(n,t),t?(h[e]=!0,o.$post(e+"/list",{filter:t},function(t){o.gotData(t,i),delete h[e]},function(){delete h[e]})):i&&i(),t):void this.$post(e+"/list",sendData,function(n){t||u.source.push(e),o.gotData(n,i)})})},this.get=function(e,t,n){t.constructor!==Array&&(t=[t]),o.fetch(e,{id:t},null,function(){var i=[],r=a[e];for(var o in t)i.push(r.get(o));n(i)})},this.gotModel=function(e){for(var t in e){var n=e[t];localStorage["description:"+t]=JSON.stringify(e),f[t]=z(n),t in a||(a[t]=Lazy({}))}},this.describe=function(e,t){var n=f[e];if(n)t&&t(n);else if(e in h)setTimeout(function(){o.describe(e,t)},500);else{if(e in p)return;var i="description:"+e;i in localStorage?(this.gotModel(JSON.parse(localStorage[i])),t&&t(f[e])):(h[e]=!0,this.$post(e+"/describe").then(function(n){o.gotModel(n),t&&t(f[e]),delete h[e]},function(t){this.events.modelNotFound.handle(e),p[e]=!0}))}},this.addBuilderHandler=function(e,t){var n=utils.hash(t);e in l||(l[e]=new Handler),e in d||(d[e]={}),l.addHandler(t),e in f&&(Lazy(d[e]).map(function(e){return e.toString()}).contains(t.toString())||(t.apply(this,[o.modelCache[e]]),d[e].push(n)))},this.connect=function(e){this.isConnected?e(this.connection.options):this.connection.connect(function(t){o.isConnected=!0,e(t)})},this.query=function(e,t,n,i){var r=utils.makeFilter(t),o=v(e);this.fetch(e,t,n,function(e){i(o.filter(r).values().toArray())})},this.delete=function(e,t,n){return this.$post(e+"/delete",{id:t},n)}};reWheelORM.prototype.get=function(e,t){var n=this,i=!1,r=e;return t.constructor!==Array&&(i=!0,t=[t]),new Promise(function(e,o){try{n.$orm.connect(function(){i?n.$orm.get(r,t,function(t){e(t[0])}):n.$orm.get(r,t,e)})}catch(e){o(e)}})},reWheelORM.prototype.query=function(e,t,n){var i=this;return new Promise(function(r,o){var a=null;n&&n.constructor===Array&&n.length?a=n:n&&n.constructor===String&&n.length&&(a=n.split(","));try{i.$orm.isConnected?i.$orm.query(e,t,a,r):i.$orm.connect(function(){i.$orm.query(e,t,a,r)})}catch(e){o(e)}})},reWheelORM.prototype.delete=function(e,t){var n=this;return new Promise(function(i,r){try{n.$orm.connected?n.$orm.delete(e,t,i):n.$orm.connect(function(){n.$orm.delete(e,t,i)})}catch(e){r(e)}})};
},{}]},{},[1])